# Maintainer: Markus Kitsinger (SwooshyCueb) <root@swooshalicio.us>
# Contributor: Piotr Gorski <lucjan.lucjanov@gmail.com>
# Contributor: Jan Alexander Steffens (heftig) <jan.steffens@gmail.com>
# Contributor: Tobias Powalowski <tpowa@archlinux.org>
# Contributor: Thomas Baechler <thomas@archlinux.org>

### BUILD OPTIONS
# Set these variables to ANYTHING that is not null to enable them

### Tweak kernel options prior to a build via nconfig
_makenconfig=

### Tweak kernel options prior to a build via menuconfig
_makemenuconfig=

### Tweak kernel options prior to a build via xconfig
_makexconfig=

### Tweak kernel options prior to a build via gconfig
_makegconfig=

# NUMA is optimized for multi-socket motherboards.
# A single multi-core CPU actually runs slower with NUMA enabled.
# See, https://bugs.archlinux.org/task/31187
_NUMAdisable=

# Compile ONLY used modules to VASTLYreduce the number of modules built
# and the build time.
#
# To keep track of which modules are needed for your specific system/hardware,
# give module_db script a try: https://aur.archlinux.org/packages/modprobed-db
# This PKGBUILD read the database kept if it exists
#
# More at this wiki page ---> https://wiki.archlinux.org/index.php/Modprobed-db
_localmodcfg=

# Use the current kernel's .config file
# Enabling this option will use the .config of the RUNNING kernel rather than
# the ARCH defaults. Useful when the package gets updated and you already went
# through the trouble of customizing your config options.  NOT recommended when
# a new kernel is released, but again, convenient for package bumps.
_use_current=

### Running with a 1000 HZ tick rate
_1k_HZ_ticks=y

### Do not edit below this line unless you know what you're doing

pkgbase=linux-kitsinger-5.14
# pkgname=('linux-kitsinger-5.14' 'linux-kitsinger-5.14-headers' 'linux-kitsinger-5.14-docs')
_major=5.14
_minor=21
pkgver=${_major}.${_minor}
_srcname=linux-${pkgver}
#_srcname=linux-${_major}
pkgrel=2
pkgdesc='Linux with AUFS, pcie-reset, futex2, etc'
arch=('x86_64')
url="https://github.com/SwooshyCueb/linux-kitsinger-PKGBUILD"
license=('GPL2')
options=('!strip' '!debug')
makedepends=('kmod' 'bc' 'libelf' 'python-sphinx' 'python-sphinx_rtd_theme'
             'graphviz' 'imagemagick' 'pahole' 'cpio' 'perl' 'tar' 'xz')
#_lucjanpath="https://raw.githubusercontent.com/sirlucjan/kernel-patches/master/${_major}"
_lucjanpath="https://gitlab.com/sirlucjan/kernel-patches/raw/master/${_major}"

_aufs_repo_name="aufs5-standalone"
_aufs_repo="https://github.com/sfjro/${_aufs_repo_name}.git"
_aufs_fragment="#commit=05607e3cb465c625e40d03871dac369ecd5a8b0e"

_gcc_path="cpu-patches-sep"
_gcc_patch="0001-cpu-${_major}-merge-graysky-s-patchset.patch"
_arch_path="arch-patches-v11-sep"
_futex_path="futex-zen-patches"
_futex_patch="0001-futex-resync-from-gitlab.collabora.com.patch"
_futex2_path="futex2-zen-patches"
_futex2_patch="0001-futex2-resync-from-gitlab.collabora.com.patch"
_fixes_path="fixes-miscellaneous-v8-sep"
_ntfs_path="ntfs3-patches-v14-sep"
_writeback_path="writeback-patches-sep"
_zen_path="zen-patches-v4-sep"

_kernel_git_path="https://git.kernel.org/pub/scm/linux/kernel/git"
_dtor_input_path="${_kernel_git_path}/dtor/input.git/patch/"
_hid_path="${_kernel_git_path}/hid/hid.git/patch/"
_pci_reset_path="${_kernel_git_path}/helgaas/pci.git/patch/"
_torvalds_path="${_kernel_git_path}/torvalds/linux.git/patch/"
_tip_path="${_kernel_git_path}/tip/tip.git/patch/"

_tonyk_path="https://gitlab.collabora.com/tonyk/linux/-/commit"

_lkml_path="https://lore.kernel.org/lkml"
_blockseq_t="${_lkml_path}/20210712230530.29323"
_blockseq_s="mcroce@linux.microsoft.com"
_amd_psf_t="${_lkml_path}/20210723093209.714328"
_amd_psf_s="namit@vmware.com"

_amdgfx_path="https://lore.kernel.org/amd-gfx"
_amd_dcc_t="${_amdgfx_path}/20210914235948.893422"
_joshie_s="joshua@froggi.es"

_hakavlad_gh="https://raw.githubusercontent.com/hakavlad"

source=("https://www.kernel.org/pub/linux/kernel/v5.x/${_srcname}.tar.xz"
        "https://www.kernel.org/pub/linux/kernel/v5.x/${_srcname}.tar.sign"
        "${_aufs_repo_name}::git+${_aufs_repo}${_aufs_fragment}"
        "${_lucjanpath}/${_gcc_path}/${_gcc_patch}"
        "${_lucjanpath}/${_arch_path}/0001-ZEN-Add-sysctl-and-CONFIG-to-disallow-unprivileged-C.patch"
        "${_lucjanpath}/${_arch_path}/0002-Bluetooth-btusb-Add-support-for-IMC-Networks-Mediate.patch"
        "${_lucjanpath}/${_arch_path}/0003-Bluetooth-btusb-Add-support-for-Foxconn-Mediatek-Chi.patch"
        "${_lucjanpath}/${_arch_path}/0004-ALSA-pci-rme-Set-up-buffer-type-properly.patch"
        "${_lucjanpath}/${_futex_path}/${_futex_patch}"
        "${_lucjanpath}/${_futex2_path}/${_futex2_patch}"
        "${_lucjanpath}/${_fixes_path}/0001-net-sched-allow-configuring-cake-qdisc-as-default.patch"
        "${_lucjanpath}/${_fixes_path}/0002-infiniband-Fix-__read_overflow2-error-with-O3-inlini.patch"
        "${_lucjanpath}/${_fixes_path}/0003-kbuild-add-fcf-protection-none-to-retpoline-flags.patch"
        "${_lucjanpath}/${_fixes_path}/0004-mm-Stop-kswapd-early-when-nothing-s-waiting-for-it-t.patch"
        "${_lucjanpath}/${_fixes_path}/0005-mm-Fully-disable-watermark-boosting-when-it-isn-t-us.patch"
        "${_lucjanpath}/${_fixes_path}/0006-mm-Don-t-stop-kswapd-on-a-per-node-basis-when-there-.patch"
        "${_lucjanpath}/${_fixes_path}/0007-kbuild-Disable-stack-conservation-for-GCC.patch"
        "${_lucjanpath}/${_fixes_path}/0008-pci-Enable-overrides-for-missing-ACS-capabilities.patch"
        "${_lucjanpath}/${_fixes_path}/0009-ZEN-Add-OpenRGB-patches.patch"
        "${_lucjanpath}/${_fixes_path}/0010-scsi-sd-Optimal-I-O-size-should-be-a-multiple-of-rep.patch"
        "${_lucjanpath}/${_fixes_path}/0011-iomap-avoid-deadlock-if-memory-reclaim-is-triggered-.patch"
        "${_lucjanpath}/${_fixes_path}/0012-tty-Allow-setting-the-number-of-available-virtual-TT.patch"
        "${_lucjanpath}/${_fixes_path}/0013-fs-add-a-filemap_fdatawrite_wbc-helper.patch"
        "${_lucjanpath}/${_fixes_path}/0014-NFS-Always-provide-aligned-buffers-to-the-RPC-read-l.patch"
        "${_lucjanpath}/${_fixes_path}/0015-SUNRPC-Simplify-socket-shutdown-when-not-reusing-TCP.patch"
        "${_lucjanpath}/${_fixes_path}/0016-SUNRPC-Tweak-TCP-socket-shutdown-in-the-RPC-client.patch"
        "${_lucjanpath}/${_fixes_path}/0017-Revert-ZEN-Add-OpenRGB-patches.patch"
        "${_lucjanpath}/${_fixes_path}/0018-i2c-busses-Add-SMBus-capability-to-work-with-OpenRGB.patch"
        "${_lucjanpath}/${_fixes_path}/0019-nvme-don-t-memset-the-normal-read-write-command.patch"
        "${_lucjanpath}/${_ntfs_path}/0001-fs-ntfs3-Add-headers-and-misc-files.patch"
        "${_lucjanpath}/${_ntfs_path}/0002-fs-ntfs3-Add-initialization-of-super-block.patch"
        "${_lucjanpath}/${_ntfs_path}/0003-fs-ntfs3-Add-bitmap.patch"
        "${_lucjanpath}/${_ntfs_path}/0004-fs-ntfs3-Add-file-operations-and-implementation.patch"
        "${_lucjanpath}/${_ntfs_path}/0005-fs-ntfs3-Add-attrib-operations.patch"
        "${_lucjanpath}/${_ntfs_path}/0006-fs-ntfs3-Add-compression.patch"
        "${_lucjanpath}/${_ntfs_path}/0007-fs-ntfs3-Add-NTFS-journal.patch"
        "${_lucjanpath}/${_ntfs_path}/0008-fs-ntfs3-Add-Kconfig-Makefile-and-doc.patch"
        "${_lucjanpath}/${_ntfs_path}/0009-fs-ntfs3-Add-NTFS3-in-fs-Kconfig-and-fs-Makefile.patch"
        "${_lucjanpath}/${_ntfs_path}/0010-fs-ntfs3-Add-MAINTAINERS.patch"
        "${_lucjanpath}/${_ntfs_path}/0011-fs-ntfs3-Fix-various-spelling-mistakes.patch"
        "${_lucjanpath}/${_ntfs_path}/0012-fs-ntfs3-Use-linux-log2-is_power_of_2-function.patch"
        "${_lucjanpath}/${_ntfs_path}/0013-fs-ntfs3-Add-ifndef-define-to-all-header-files.patch"
        "${_lucjanpath}/${_ntfs_path}/0014-fs-ntfs3-Fix-integer-overflow-in-multiplication.patch"
        "${_lucjanpath}/${_ntfs_path}/0015-fs-ntfs3-Remove-unused-variable-cnt-in-ntfs_security.patch"
        "${_lucjanpath}/${_ntfs_path}/0016-fs-ntfs3-Fix-one-none-utf8-char-in-source-file.patch"
        "${_lucjanpath}/${_ntfs_path}/0017-fs-ntfs3-Fix-fall-through-warnings-for-Clang.patch"
        "${_lucjanpath}/${_ntfs_path}/0018-fs-ntfs3-Remove-unused-including-linux-version.h.patch"
        "${_lucjanpath}/${_ntfs_path}/0019-fs-ntfs3-Restyle-comment-block-in-ni_parse_reparse.patch"
        "${_lucjanpath}/${_ntfs_path}/0020-fs-ntfs3-Use-kernel-ALIGN-macros-over-driver-specifi.patch"
        "${_lucjanpath}/${_ntfs_path}/0021-fs-ntfs3-Do-not-use-driver-own-alloc-wrappers.patch"
        "${_lucjanpath}/${_ntfs_path}/0022-fs-ntfs3-Use-kcalloc-kmalloc_array-over-kzalloc-kmal.patch"
        "${_lucjanpath}/${_ntfs_path}/0023-fs-ntfs3-add-checks-for-allocation-failure.patch"
        "${_lucjanpath}/${_ntfs_path}/0024-fs-ntfs3-fix-an-error-code-in-ntfs_get_acl_ex.patch"
        "${_lucjanpath}/${_ntfs_path}/0025-fs-ntfs3-Fix-error-code-in-indx_add_allocate.patch"
        "${_lucjanpath}/${_ntfs_path}/0026-fs-ntfs3-Potential-NULL-dereference-in-hdr_find_spli.patch"
        "${_lucjanpath}/${_ntfs_path}/0027-fs-ntfs3-Fix-error-handling-in-indx_insert_into_root.patch"
        "${_lucjanpath}/${_ntfs_path}/0028-fs-ntfs3-Restyle-comments-to-better-align-with-kerne.patch"
        "${_lucjanpath}/${_ntfs_path}/0029-fs-ntfs3-Remove-fat-ioctl-s-from-ntfs3-driver-for-no.patch"
        "${_lucjanpath}/${_ntfs_path}/0030-fs-ntfs3-Rework-file-operations.patch"
        "${_lucjanpath}/${_ntfs_path}/0031-fs-ntfs3-Restyle-comments-to-better-align-with-kerne.patch"
        "${_lucjanpath}/${_ntfs_path}/0032-fs-ntfs3-Fix-integer-overflow-in-ni_fiemap-with-fiem.patch"
        "${_lucjanpath}/${_ntfs_path}/0033-fs-ntfs3-Remove-unnecessary-condition-checking-from-.patch"
        "${_lucjanpath}/${_ntfs_path}/0034-fs-ntfs3-Remove-GPL-boilerplates-from-decompress-lib.patch"
        "${_lucjanpath}/${_ntfs_path}/0035-fs-ntfs3-Change-how-module-init-info-messages-are-di.patch"
        "${_lucjanpath}/${_ntfs_path}/0036-fs-ntfs3-Remove-unnecesarry-mount-option-noatime.patch"
        "${_lucjanpath}/${_ntfs_path}/0037-fs-ntfs3-Remove-unnecesarry-remount-flag-handling.patch"
        "${_lucjanpath}/${_ntfs_path}/0038-fs-ntfs3-Convert-mount-options-to-pointer-in-sbi.patch"
        "${_lucjanpath}/${_ntfs_path}/0039-fs-ntfs3-Use-new-api-for-mounting.patch"
        "${_lucjanpath}/${_ntfs_path}/0040-fs-ntfs3-Init-spi-more-in-init_fs_context-than-fill_.patch"
        "${_lucjanpath}/${_ntfs_path}/0041-fs-ntfs3-Make-mount-option-nohidden-more-universal.patch"
        "${_lucjanpath}/${_ntfs_path}/0042-fs-ntfs3-Add-iocharset-mount-option-as-alias-for-nls.patch"
        "${_lucjanpath}/${_ntfs_path}/0043-fs-ntfs3-Rename-mount-option-no_acs_rules-no-acsrule.patch"
        "${_lucjanpath}/${_ntfs_path}/0044-fs-ntfs3-Show-uid-gid-always-in-show_options.patch"
        "${_lucjanpath}/${_ntfs_path}/0045-fs-ntfs3-Remove-redundant-initialization-of-variable.patch"
        "${_lucjanpath}/${_ntfs_path}/0046-fs-ntfs3.-Add-forward-declarations-for-structs-to-de.patch"
        "${_lucjanpath}/${_ntfs_path}/0047-fs-ntfs3-Add-missing-header-files-to-ntfs.h.patch"
        "${_lucjanpath}/${_ntfs_path}/0048-fs-ntfs3-Add-missing-headers-and-forward-declaration.patch"
        "${_lucjanpath}/${_ntfs_path}/0049-fs-ntfs3-Add-missing-header-and-guards-to-lib-header.patch"
        "${_lucjanpath}/${_ntfs_path}/0050-fs-ntfs3-Change-right-headers-to-bitfunc.c.patch"
        "${_lucjanpath}/${_ntfs_path}/0051-fs-ntfs3-Change-right-headers-to-upcase.c.patch"
        "${_lucjanpath}/${_ntfs_path}/0052-fs-ntfs3-Change-right-headers-to-lznt.c.patch"
        "${_lucjanpath}/${_ntfs_path}/0053-fs-ntfs3-Remove-unneeded-header-files-from-c-files.patch"
        "${_lucjanpath}/${_ntfs_path}/0054-fs-ntfs3-Limit-binary-search-table-size.patch"
        "${_lucjanpath}/${_ntfs_path}/0055-fs-ntfs3-Make-binary-search-to-search-smaller-chunks.patch"
        "${_lucjanpath}/${_ntfs_path}/0056-fs-ntfs3-Always-use-binary-search-with-entry-search.patch"
        "${_lucjanpath}/${_ntfs_path}/0057-fs-ntfs3-Remove-before-constant-in-ni_insert_residen.patch"
        "${_lucjanpath}/${_ntfs_path}/0058-fs-ntfs3-Place-Comparisons-constant-right-side-of-th.patch"
        "${_lucjanpath}/${_ntfs_path}/0059-fs-ntfs3-Remove-braces-from-single-statment-block.patch"
        "${_lucjanpath}/${_ntfs_path}/0060-fs-ntfs3-Remove-tabs-before-spaces-from-comment.patch"
        "${_lucjanpath}/${_ntfs_path}/0061-fs-ntfs3-Fix-ntfs_look_for_free_space-does-only-repo.patch"
        "${_lucjanpath}/${_ntfs_path}/0062-fs-ntfs3-Remove-always-false-condition-check.patch"
        "${_lucjanpath}/${_ntfs_path}/0063-fs-ntfs3-Use-clamp-max-macros-instead-of-comparisons.patch"
        "${_lucjanpath}/${_ntfs_path}/0064-fs-ntfs3-Use-min-max-macros-instated-of-ternary-oper.patch"
        "${_lucjanpath}/${_ntfs_path}/0065-fs-ntfs3-Fix-wrong-error-message-Logfile-UpCase.patch"
        "${_lucjanpath}/${_ntfs_path}/0066-fs-ntfs3-Change-EINVAL-to-ENOMEM-when-d_make_root-fa.patch"
        "${_lucjanpath}/${_ntfs_path}/0067-fs-ntfs3-Remove-impossible-fault-condition-in-fill_s.patch"
        "${_lucjanpath}/${_ntfs_path}/0068-fs-ntfs3-Return-straight-without-goto-in-fill_super.patch"
        "${_lucjanpath}/${_ntfs_path}/0069-fs-ntfs3-Remove-unnecessary-variable-loading-in-fill.patch"
        "${_lucjanpath}/${_ntfs_path}/0070-fs-ntfs3-Use-sb-instead-of-sbi-sb-in-fill_super.patch"
        "${_lucjanpath}/${_ntfs_path}/0071-fs-ntfs3-Remove-tmp-var-is_ro-in-ntfs_fill_super.patch"
        "${_lucjanpath}/${_ntfs_path}/0072-fs-ntfs3-Remove-tmp-pointer-bd_inode-in-fill_super.patch"
        "${_lucjanpath}/${_ntfs_path}/0073-fs-ntfs3-Remove-tmp-pointer-upcase-in-fill_super.patch"
        "${_lucjanpath}/${_ntfs_path}/0074-fs-ntfs3-Initialize-pointer-before-use-place-in-fill.patch"
        "${_lucjanpath}/${_ntfs_path}/0075-fs-ntfs3-Initiliaze-sb-blocksize-only-in-one-place-r.patch"
        "${_lucjanpath}/${_ntfs_path}/0076-Doc-fs-ntfs3-Fix-rst-format-and-make-it-cleaner.patch"
        "${_lucjanpath}/${_ntfs_path}/0077-fs-ntfs3-Fix-a-memory-leak-on-object-opts.patch"
        "${_lucjanpath}/${_ntfs_path}/0078-fs-ntfs3-Fix-insertion-of-attr-in-ni_ins_attr_ext.patch"
        "${_lucjanpath}/${_ntfs_path}/0079-fs-ntfs3-Change-max-hardlinks-limit-to-4000.patch"
        "${_lucjanpath}/${_ntfs_path}/0080-fs-ntfs3-Add-sync-flag-to-ntfs_sb_write_run-and-al_u.patch"
        "${_lucjanpath}/${_ntfs_path}/0081-fs-ntfs3-Remove-a-useless-test-in-indx_find.patch"
        "${_lucjanpath}/${_ntfs_path}/0082-fs-ntfs3-Remove-a-useless-shadowing-variable.patch"
        "${_lucjanpath}/${_ntfs_path}/0083-fs-ntfs3-Remove-deprecated-mount-options-nls.patch"
        "${_lucjanpath}/${_ntfs_path}/0084-fs-ntfs3-Fix-logical-error-in-ntfs_create_inode.patch"
        "${_lucjanpath}/${_ntfs_path}/0085-fs-ntfs3-Move-ni_lock_dir-and-ni_unlock-into-ntfs_cr.patch"
        "${_lucjanpath}/${_ntfs_path}/0086-fs-ntfs3-Refactor-ntfs_get_acl_ex-for-better-readabi.patch"
        "${_lucjanpath}/${_ntfs_path}/0087-fs-ntfs3-Pass-flags-to-ntfs_set_ea-in-ntfs_set_acl_e.patch"
        "${_lucjanpath}/${_ntfs_path}/0088-fs-ntfs3-Change-posix_acl_equiv_mode-to-posix_acl_up.patch"
        "${_lucjanpath}/${_ntfs_path}/0089-fs-ntfs3-Refactoring-lock-in-ntfs_init_acl.patch"
        "${_lucjanpath}/${_ntfs_path}/0090-fs-ntfs3-Reject-mount-if-boot-s-cluster-size-media-s.patch"
        "${_lucjanpath}/${_ntfs_path}/0091-fs-ntfs3-Refactoring-of-ntfs_init_from_boot.patch"
        "${_lucjanpath}/${_ntfs_path}/0092-fs-ntfs3-Check-for-NULL-if-ATTR_EA_INFO-is-incorrect.patch"
        "${_lucjanpath}/${_ntfs_path}/0093-fs-ntfs3-Use-available-posix_acl_release-instead-of-.patch"
        "${_lucjanpath}/${_ntfs_path}/0094-fs-ntfs3-Remove-locked-argument-in-ntfs_set_ea.patch"
        "${_lucjanpath}/${_ntfs_path}/0095-fs-ntfs3-Refactoring-of-ntfs_set_ea.patch"
        "${_lucjanpath}/${_ntfs_path}/0096-fs-ntfs3-Forbid-FALLOC_FL_PUNCH_HOLE-for-normal-file.patch"
        "${_lucjanpath}/${_ntfs_path}/0097-fs-ntfs3-Remove-unnecessary-functions.patch"
        "${_lucjanpath}/${_ntfs_path}/0098-fs-ntfs3-Keep-prealloc-for-all-types-of-files.patch"
        "${_lucjanpath}/${_ntfs_path}/0099-fs-ntfs3-Fix-memory-leak-if-fill_super-failed.patch"
        "${_lucjanpath}/${_ntfs_path}/0100-fs-ntfs3-Rework-ntfs_utf16_to_nls.patch"
        "${_lucjanpath}/${_ntfs_path}/0101-fs-ntfs3-Refactor-ntfs_readlink_hlp.patch"
        "${_lucjanpath}/${_ntfs_path}/0102-fs-ntfs3-Refactor-ntfs_create_inode.patch"
        "${_lucjanpath}/${_ntfs_path}/0103-fs-ntfs3-Refactor-ni_parse_reparse.patch"
        "${_lucjanpath}/${_ntfs_path}/0104-fs-ntfs3-Refactor-ntfs_read_mft.patch"
        "${_lucjanpath}/${_writeback_path}/0001-writeback-Track-number-of-inodes-under-writeback.patch"
        "${_lucjanpath}/${_writeback_path}/0002-writeback-Reliably-update-bandwidth-estimation.patch"
        "${_lucjanpath}/${_writeback_path}/0003-writeback-Fix-bandwidth-estimate-for-spiky-workload.patch"
        "${_lucjanpath}/${_writeback_path}/0004-writeback-Rename-domain_update_bandwidth.patch"
        "${_lucjanpath}/${_writeback_path}/0005-writeback-Use-READ_ONCE-for-unlocked-reads-of-writeb.patch"
        "${_lucjanpath}/${_zen_path}/0001-ZEN-Add-VHBA-driver.patch"
        #"${_lucjanpath}/${_zen_path}/0002-ZEN-intel-pstate-Implement-enable-parameter.patch"
        "${_lucjanpath}/${_zen_path}/0003-ZEN-Update-VHBA-driver.patch"
        "${_lucjanpath}/clearlinux-patches-sep/0017-xattr-allow-setting-user.-attributes-on-symlinks-by-.patch"
        "${_lucjanpath}/ll-patches/0004-mm-set-8-megabytes-for-address_space-level-file-read.patch"
        "${_lucjanpath}/android-patches-v2/0001-android-export-symbold-and-enable-building-ashmem-an.patch"
        "${_lucjanpath}/lqx-patches-sep/0001-zen-Allow-MSR-writes-by-default.patch"
        "${_lucjanpath}/lqx-patches-sep/0002-PCI-Add-Intel-remapped-NVMe-device-support.patch"

        # https://git.kernel.org/pub/scm/linux/kernel/git/tip/tip.git/log/?h=locking/core
        # https://git.kernel.org/pub/scm/linux/kernel/git/tip/tip.git/log/?h=bc67f1c454fbc79b148f0b47227929da82f4b026
        #"1001-futex-Move-to-kernel-futex.patch::${_tip_path}?id=77e52ae35463521041906c510fe580d15663bb93"
        #"1002-futex-Split-out-syscalls.patch::${_tip_path}?id=af8cc9600bbf2251b04c56139f7c83f87c3f878a"
        #"1003-futex-Rename-unqueue_me.patch::${_tip_path}?id=bce760d34bc2adcfd97e859a91407df51913f7b0"
        #"1004-futex-Rename-futex_wait_queue_me.patch::${_tip_path}?id=5622eb20520d284a52668e9f911a7f37e7b3f12c"
        #"1005-futex-Rename-queue_unlock.patch::${_tip_path}?id=e7ba9c8fed298fef5aa614685df61db6e6551fa0"
        #"1006-futex-Rename-unqueue_futex.patch::${_tip_path}?id=af92dcea186ed7bcd5cc013163ec47a8a135ee97"
        #"1007-futex-Rename-hash_futex.patch::${_tip_path}?id=eee5a7bc96becd7cdb8e4fabd327ca5e49136704"
        #"1008-futex-Rename-futex_value_locked.patch::${_tip_path}?id=966cb75f86fb15e2659c8105d20d4889e18dda24"
        #"1009-futex-Split-out-PI-futex.patch::${_tip_path}?id=85dc28fa4ec058645c29bda952d901b29dfaa0b0"
        #"1010-futex-Rename-hb_waiter.patch::${_tip_path}?id=832c0542c0f71f7d2ba10e987a1ab520813e6bd7"
        #"1011-futex-Rename-match_futex.patch::${_tip_path}?id=f56a76fde353dd274eef0ea9d371379950079951"
        #"1012-futex-Rename-mark_wake_futex.patch::${_tip_path}?id=95c336a7d8f0c1c34ee99e0162dc64d283da7618"
        #"1013-futex-Split-out-requeue.patch::${_tip_path}?id=e5c6828493b5fa6a3c4606b43e80ab6c5ec1111f"
        #"1014-futex-Split-out-waitwake.patch::${_tip_path}?id=a046f1a0d3e320cfee6bdac336416a537f49e7c6"
        #"1015-futex-Simplify-double_lock_hb.patch::${_tip_path}?id=bff7c57c2f50dca7b5e320f499e0898c3fb8a9ff"
        #"1016-futex-Implement-sys_futex_waitv.patch::${_tip_path}?id=bf69bad38cf63d980e8a603f8d1bd1f85b5ed3d9"
        #"1017-futex-x86-Wire-up-sys_futex_waitv.patch::${_tip_path}?id=039c0ec9bb77446d7ada7f55f90af9299b28ca49"
        #"1018-futex-arm-Wire-up-sys_futex_waitv.patch::${_tip_path}?id=ea7c45fde5aa3e761aaddb7902a31a95cb120e7b"
        #"1019-selftests-futex-add-sys_futex_waitv-test.patch::${_tip_path}?id=5e59c1d1c78c9cdd8834f3242db4a76f617fa4ad"
        #"1020-selftests-futex-test-sys_futex_waitv-timeout.patch::${_tip_path}?id=02e56ccbaefcb1a78bd089a7b5beca754aca4db9"
        #"1021-selftests-futex-test-sys_futex_waitv-wouldblock.patch::${_tip_path}?id=9d57f7c79748920636f8293d2f01192d702fe390"
        #"1022-futex2-Documentat-sys_futex_waitv-uAPI.patch::${_tip_path}?id=dd0aa2cd2e9e3e49b8c3b43924dc1a1d4e22b4d1"
        #"1023-futex-Fix-PREEMPT_RT-build.patch::${_tip_path}?id=4d38167330910ddb15b1add5b5cef835677a29fd"
        #"1024-docs-futex-Fix-kernel-doc-references.patch::${_tip_path}?id=bc67f1c454fbc79b148f0b47227929da82f4b026"
        # https://git.kernel.org/pub/scm/linux/kernel/git/tip/tip.git/log/?h=9d417cbe36eee7afdd85c2e871685f8dab7c2dba
        #"1025-ARM-9122-1-select-HAVE_FUTEX_CMPXCHG.patch::${_tip_path}?id=9d417cbe36eee7afdd85c2e871685f8dab7c2dba"
        # https://git.kernel.org/pub/scm/linux/kernel/git/tip/tip.git/log/?h=4e0d84634445ed550498d613a49ea8f6cfa5e66c
        #"1026-futex-ensure-futex_atomic_cmpxchg_inatomic-is-presen.patch::${_tip_path}?id=3f2bedabb62c6210df63b604dc988d2f7f56f947"
        #"1027-futex-remove-futex_cmpxchg-detection.patch::${_tip_path}?id=3297481d688a5cc2973ea58bd78e66b8639748b1"
        #"1028-futex-fix-sparc32-m68k-nds32-build-regression.patch::${_tip_path}?id=4e0d84634445ed550498d613a49ea8f6cfa5e66c"
        # https://gitlab.collabora.com/tonyk/linux/-/commits/futex2-dev/
        #"1029-futex2-Add-sysfs-entry-for-syscall-numbers.patch::${_tonyk_path}/d810c70ed7b8228349af3c277f8c3cc0d5fa0f7b"
        # https://gitlab.collabora.com/tonyk/linux/-/commits/tonyk/futex_waitv/
        #"1030-futex-Add-entry-point-for-FUTEX_WAIT_MULTIPLE.patch::${_tonyk_path}/b70e738f08403950aa3053c36b98c6b0eeb0eb90"

        # https://lore.kernel.org/linux-pci/20210818224603.GA3142002@bjorn-Precision-5520/
        # https://git.kernel.org/pub/scm/linux/kernel/git/helgaas/pci.git/refs/?h=pci/reset
        "2002-PCI-Cache-PCIe-Device-Capabilities-register.patch::${_pci_reset_path}?id=69139244806537f9d51364f37fe146bb2ee88a05"
        "2003-PCI-Add-pcie_reset_flr-with-probe-argument.patch::${_pci_reset_path}?id=56f107d7813f116484019617043393a7753ffcbf"
        "2004-PCI-Add-array-to-track-reset-method-ordering.patch::${_pci_reset_path}?id=e20afa06244eb5d7fa850f9fe2a78ae17ba96f81"
        "2005-PCI-Remove-reset_fn-field-from-pci_dev.patch::${_pci_reset_path}?id=4ec36dfeb155b72da8d28ab006a46f2f8b981eac"
        "2006-PCI-Allow-userspace-to-query-and-set-device-reset-me.patch::${_pci_reset_path}?id=d88f521da3efd698e36d0d504a2abba6ac4f5ef8"
        "2007-PCI-Add-pci_set_acpi_fwnode-to-set-ACPI_COMPANION.patch::${_pci_reset_path}?id=3a15955d7cf0b6c7527ee3bd97c3c355450e3fa1"
        "2008-PCI-Use-acpi_pci_power_manageable.patch::${_pci_reset_path}?id=4273e64cc4ebb881e1954d768020f5440491dcd9"
        "2009-PCI-Setup-ACPI-fwnode-early-and-at-the-same-time-wit.patch::${_pci_reset_path}?id=375553a93201a58a52f142eab19545a07aa1eaf5"
        "2010-PCI-Add-support-for-ACPI-_RST-reset-method.patch::${_pci_reset_path}?id=6937b7dd434962377e00efc04adac0390c287199"
        "2011-PCI-Change-the-type-of-probe-argument-in-reset-funct.patch::${_pci_reset_path}?id=9bdc81ce440ec6ea899b236879aee470ec388020"

        # https://lore.kernel.org/lkml/20210712230530.29323-1-mcroce@linux.microsoft.com/T/
        "3001-block-add-disk-sequence-number.patch::${_blockseq_t}-2-${_blockseq_s}/raw"
        "3002-block-export-the-diskseq-in-uevents.patch::${_blockseq_t}-3-${_blockseq_s}/raw"
        "3003-block-add-ioctl-to-read-the-disk-sequence-number.patch::${_blockseq_t}-4-${_blockseq_s}/raw"
        "3004-block-export-diskseq-in-sysfs.patch::${_blockseq_t}-5-${_blockseq_s}/raw"
        "3005-block-add-a-helper-to-raise-a-media-changed-event.patch::${_blockseq_t}-6-${_blockseq_s}/raw"
        "3006-loop-raise-media_change-event.patch::${_blockseq_t}-7-${_blockseq_s}/raw"

        # https://lore.kernel.org/lkml/20210723093209.714328-1-namit@vmware.com/T/
        "4070-iommu-amd-Selective-flush-on-unmap.patch::${_amd_psf_t}-2-${_amd_psf_s}/raw"
        "4071-iommu-amd-Do-not-use-flush-queue-when-NpCache-is-on.patch::${_amd_psf_t}-3-${_amd_psf_s}/raw"
        "4072-iommu-Improve-iommu_iotlb_gather-helpers.patch::${_amd_psf_t}-4-${_amd_psf_s}/raw"
        "4073-iommu-Factor-iommu_iotlb_gather_is_disjoint-out.patch::${_amd_psf_t}-5-${_amd_psf_s}/raw"
        "4074-iommu-amd-Tailored-gather-logic-for-AMD.patch::${_amd_psf_t}-6-${_amd_psf_s}/raw"
        "4075-iommu-amd-Sync-once-for-scatter-gather-operations.patch::${_amd_psf_t}-7-${_amd_psf_s}/raw"
        "4076-iommu-amd-Use-only-natural-aligned-flushes-in-a-VM.patch::${_amd_psf_t}-8-${_amd_psf_s}/raw"

        # https://lore.kernel.org/lkml/20210924061205.5523-1-deepak.sharma@amd.com/
        "0000-x86-ACPI-cstate-Optimize-C3-entry-on-AMD-CPUs.patch::${_lkml_path}/20210924061205.5523-1-deepak.sharma@amd.com/raw"

        # https://lore.kernel.org/amd-gfx/20210105220359.1392555-1-joshua@froggi.es/
        #"0000-drm-amdgpu-dont-limit-gtt-size-on-apus.patch::${_amdgfx_path}/20210105220359.1392555-1-${_joshie_s}/raw"

        # https://lore.kernel.org/amd-gfx/20210914235948.893422-1-joshua@froggi.es/T/
        #"5001-drm-amd-display-Use-dcc_ind_blk-value-to-set-registe.patch::${_amd_dcc_t}-1-${_joshie_s}/raw"
        #"5002-drm-amd-display-Handle-GFX10_RBPLUS-modifiers-for-dc.patch::${_amd_dcc_t}-2-${_joshie_s}/raw"
        #"5003-drm-amd-display-Add-modifiers-capable-of-DCC-image-s.patch::${_amd_dcc_t}-3-${_joshie_s}/raw"

        # le9 stuff
        # pretty confident these git repos aren't going anywhere
        "${_hakavlad_gh}/le9-patch/9f86d0bf39299c9d15558bc3e34a221da82462b0/le9ec_patches/le9ec-5.14.patch"
        "${_hakavlad_gh}/disable-i915-gem-shrinker/4e6da2a9b0602d3f80b418026d0a8bf188fc0de6/disable-drm-i915-gem-shrinker-5.10.patch"

        # https://clbin.com/VCiYJ
        "0001-pcie-reset-kludge.patch"

        # The rest of the patches came from random git repositories. In my experience, random git repositories tend to
        # vanish, so instead of pulling the files from the repositories, they will be included in this one.

        # https://github.com/Frogging-Family/linux-tkg/tree/master/linux-tkg-patches/5.14
        "0001-mm-Support-soft-dirty-flag-reset-for-VA-range.patch"
        "0002-mm-Support-soft-dirty-flag-read-with-reset.patch"

        # https://github.com/kevall474/kernel-patches/tree/main/5.13/misc-patches
        "vm.max_map_count.patch"

        # the main kernel config files
        'config')

sha512sums=('0f428cb7273de5b440b610b1a3709563e4ed955afb4df084750a8b43c45e5b000a5906780ff7079a8324fac0a8b7ecace778ab8bbf0511fba92d4dad160d7f87'
            'SKIP'
            'SKIP'
            'b1aef4f4e7350ce8132e019f76a2ac68bee8a46eb981598fbda11402e62a8bcdfd2f49e5b2cc5dcf2e96c88ad047af12d53abb9fda05c9f7acec37879e5240db'
            'ba40d02c5ed6e1b6509aa9607dd4594dc168ee2aaf92647cbd2efa4e5921b9165633c7013467b14e5934080b7c656dcaeda225fce6089bcf8fe8a336404038e1'
            'd566e5660ec5b2fabb10baacafb84ae925ddf2ba05db29f5f4225f68b49bf2ba8ccf10dfdc820b88e196265bf5aa70d8d8319acfbe813914916479b1097df7a9'
            '322106526f6a8110af558b363ec9377427f1b548ab62a0ab07f5557728aeff0ec7adb8d6f5d30585290cdb460427bbd91e7a5674b60c6049a65f469da18830d2'
            '787ea00ae9d98cac1d2bbc6d4ee17c2419cd708aef902875bc803f4be5fec8392c6c743bd80e0c9a99624b5b074ed899f7412d2ad9f41add6ee038dda2a6d0f4'
            'd1bc35682cf99fed522471c65626902b30a14cec6ef38addeb1d9c0ded9adde29aec2c3226f753a2c7f5e4a9e69d7382811c59547147d27da2a7385a830b2fe2'
            'fac5456474702a2fb73695afd2101af27111702d573b2476efb6e14f6d4f2e6d0920e360dc8269ea337d6b9cd3ee105ad3e540bd55a44c925eeba52ddc3cc098'
            '20f597c9c15dce539b2c207568e272ae6ccd0aa226f16a527534196d1e84db14980cd53d6dcc7bb35726a39ca5a5ff0dcd9fe9f2d0cc65825654892826ec7fc7'
            'e03b4ea903c164b8f306e13bbf02088f1178798724ab8478d253759ade9ad2d43172a1b0959038e01724e23eba2557151a7ea7b19cbd6ff2d5e4f7c213a46bb1'
            'dea7c15ea838fc21b2da6aad002631005e983874427b1e70629f6764c20c25a47385de4c379c187d67c48e1dd78f2c5a8ff99f1aea99fb8fb66db190ceff3626'
            '1c08226b3bf34041c171ab7d0cbc838bf3bcc77ea81446ce4f0823dee08336a3f232068187ea9f70763952d8e54fe8afb474fc99b72663ce5f407d0131310f8f'
            '49333bc1952cdf454305000f530fc2bd106bac8bbfaf6ff0dabceb4fc588146602b7f6586995b60097eb642bc70c0eb20696b1e227acd31e6ee971b133cb450d'
            'd2e412e697ea753d3e2130b63f166a8b8332447212ad832f9f67b1eba453ba3840708e3c910e53075e944ed9ae1a311fd51624157ee1ad380f4dd94f81215d2b'
            'fdf255fbdbd0bd65a20afca6906a7b5e004b5388874a5fc18d83f109047811ee588242a9906d9702fe01d0fe158d6c440cb0e07ee0e86f9a90c9c50253cd42c1'
            '8bbb1bba1d59e5b4d88e631162662110d43ef1ebc0048a2ef34bedb3690dd1137e0c8f37d4d96fa54161cbca681c9a95e9d619f606d24e50fa4b87e169e76ed8'
            'c05be8b875c91ef49db0c44a02426256a632b3adc12149ce8feccf8a01b13e1decdd16ed8080f4fbdd3ae54bbc85423ee25db14f20e2959a972ffeb1c2e66596'
            'ce13c13a16a7805b4276f92daebcb4369e0d31327ad30eff43b499600c111c75ce51b408f460bb1a1e786c58c643fc8dd8839aaf53b8d78e2ec242afcc769302'
            'b31e22287579a7647730ce90f48d17f3b1a69ac6b71c2a5a34c21b34c06f50b763797be44363466284cdd535ac28a53dd635f3cd1ab2e642ca3fa667d5c617dd'
            'f286ee54fb76434434becfdef476ca5bbf2b370f106b209bb94f417e84a926bc945bc1a64e923aeacc4f0ea567976ed61aefcf5f420baea1f943b553fa9bc6aa'
            'e05ec8bc80a8e66d8e2369b07f7d000ebae5e7f725422571b96e4237b261d94d262109bfc52921443592302f9a4c2d010d1593e5a8cd1f0dbb42c461632c5a20'
            '929e966141fa38a2d01697bf9f7c4a0563b1c90ae18feae9c3a2841dc273139bb0273611e31eda56dce5bdff6e8696cf68fa3af9572e9298c259f630952b2e27'
            'b277976410b20a2808305e30db4ab8cf3dcb7f8b110f5955dc2c6d92d8d368605bd79cc65033fbabab992ace997ebf776e14fb54e93f2e82db20e6485c8c3704'
            '9687d7ca23291e93d0bf9fa4482a874d2b30b6248e122eccc71ff42e8c93d15d49112f94f865c9b1761a72ed904c0fba38e38539bc0bd25d2270b17882384559'
            'e6b65b0a3f5a2c29699482bdd5d145153a1705acba668022f582ea66d0fc2ef981fb8ad65bfba04a2884676349d37eae10e8d41ca8283187f5a3b81c152f7192'
            'b98bca95fdae140d47469731c7307dfecebc94d50564736a0b3d83e46c5af84058257e7dc715e95068839cc26ae2f1b18800f448f0e7619941d80728de6d98ab'
            '0b652fb4d41adce4ff4229e691560f9dfb7e76f400aee3e7050dd0a8d412d4f9869fda82763cb9ff9ac54cf8b9afd2f2626ce85b3ddd6b86a009752242114170'
            'b4adbe2c1de950303af1ebfeaa256f1d13e78ea62822c95a3e3ad359b71337356efa86f93e8f104819a55c9a382329b7e6e5945bf04aef1677e55ba84385e004'
            '8568c9d981ad3f1cdc47ac8cae6e39ea4e6797d413330b0f74761a74a5adde3a9ce8995951672c5ef357627c8d5a7b32862038f5f298615420694e47c1cad62b'
            '9af80f054d6546e2e75850f8f7d807d286f543e10a133e1146efad84ccffbc36f1fa67619221b0e6aed66f9ba76bd771d3049d212402bc4d6f7ce96dd21056a0'
            '5ee63d55600f2dbb6cabe2ea9d1d6188485771b97b6988148d61c8bd0d345a0311150151d1b84ff22c00bf746c6b728c1862c073fdfe443b94cd48883504b193'
            '412ef2142f521e130881428111191f4497fab2379cee71d1147edbcde5307d4f593a60ecb11a69a2ba642c9a7605a665d4d3a082b9a898a4a1e93e35f9ded94e'
            '505aba1a28d22d14af4e50e0b4cf82ff9ef2714d6d753b03c32a0f5b14a334eb7b7efe25818d1b24e158e91efcf140c923786c33e69677bb34334f867401c192'
            'f52a0c88748defd083508523090c98c56a321f76ad255bbbfd6a715890bc32cf33f691a2890ec59efd9198ab102fe988264f789dd1de29fb1a52f1b87b901c4c'
            'f3c979ca0ece6ec48237c6de056399106f9508f6f8cce7c4c793ae6148a2b903b01acb2952dc8cd341937e12482a086742776035a3b153cf94bbd4290123e602'
            '41dce668b906c674a062deaf762dd27c0b61cf60d1c32e467f3b3b9ab4dddc373c20a350fb138e26befd450432c362af7bfe6cbbe6755e5c62213304fd254ebd'
            '6fbfd40f9a46c824274f3bd6a78fd3159550a08ed0a16eafd857c9cca62db7ff8a3798119652e2850b280748c9d33fd0c98d972578c172b7e62196c9ad717362'
            '0860ee6e2164b4c5b490c1528c777392f8ba8e4a776c34f9264b8c641f4752d47ca848feb8abfb3c9635065a7bc1a04fd33711d36037dff5e59b791e0b924202'
            '1fb3300a74f5129c7015acb562d3a49746378bb4e0a89b0ddd92a6deca21f1c8b979fa8cb64748bc128db2e82f226d02bd2da3fd6793dd4be8683e5d41f94662'
            '0db7f0d6e794d3b670c5e988bfbbf9a8d8c39bc3a73bfc07767794787523bd1ff60cfbf1e4bf0ef478015eeef1967aceb53123a8b99084b754df5283e78c9fd0'
            'e0b4235fd057d10bad638160541faed9f4675f9e87b53b2251c5a1dab902765a71e0ba77ca05001a413483a4549b94c8f70098c55f774ab0312485614f87be7a'
            '4fb512eb90e82e296822e1b7f83e1d809893df2740487d5c35c96c5e11681274318504b0efbb66fcaf50fdf8be7a09edf6452030ce2bdc24790f538597a8c36e'
            '25ba940768f1a0ef1fe97869c155c0413a704a08de058295b2a45798aab53ae4b4d5c689407f3e7ad68224befa077c6a86d2ffc290fb2e16b4718cd7f268a14d'
            'a36233fa4e038b8ea9787b2d14595e820bc5e3d485bf0666524ec286d2ebb2ecd8deda16f2e6d2f1dc02f1534ceab8fc2f49db527c6afd3d143514dd1e59ccd6'
            '58896939312ff987e2391cd8a2dde33d87f6f1ae7adb441811567424062308ef90aa9c4fd9b19b43682ce030c743ec8a5cca36a769453835dff4c4dffcd22034'
            '3b00c08c95f922632c377050d8ad0157f1a2c31c61b8349c94df8bb5368eb6a94979bcf923e48daab7289b654d825853433d97e95d6c6e14d02ef3ac2cc74b14'
            'eac248847529a5036eac63dd2da28c84b1e255f95732d34d06fc859385dbb631e5caf83187e83079d7bfe109141730a3643d333bcabedb71c51d2eb428d11bc6'
            '0a8976bbc031ae5d9caeb2b517fecf550537afd6d7c688cbb9e4fcb73d6eeae58af25ca6af747274bfc6fa41bfc7806dfc3d8b4c0ef216099b805005f1e33f77'
            '65dc638dd75c8861c1070cddde9243841192bc54e6f719e54e2eb4ff82d8c535810fe35dd7ece9e7d98f1644e1416d0a056d1a31cac84ff921b460623b3c172b'
            '6de4b40832fab8f7c5d0a86c9b484d9adbf208b2208218677e304aa911b5ae987bbbcd2d59509974a563e9d163f21bba91700f9df99405c0575bdd551e41598f'
            '7d3bd48c37546e668472c55b67d863c026c3a9c9883ecc318b589012705d1855d916d621aa2459c8ed5b14f0cb8675bf2932b10c1cbd54f31537f0c44b8f029b'
            'ead1bb39d480cd46e50bdb1ba041205dfd8a4d2f93255dec134c27baa67f336997c0213625cd68b7685e4a4aa6e8ca161c89541c2fa692623daa984d6390857e'
            'a4a9336180ab409b99003043306945ef53a6a9879e6ce2f03123aa75b47d4e743a4e20e0ed9acfde59573f924ad17ffa0bf5f548209d8c429a14316b504e1430'
            '64f152a8f0305ea866e0d2d6e071cd29010bc312961f2ac78b4a4db0ad1c98a538a8db9c64ee5ee88f0679fdce31f3a360192214b994d8fc4203495c7a9a6ef9'
            'faaae726ed27cb6fdc0b95ddf62eb4a60d5f9366062c0192474f703d5cde4853bfb99f20554ec6f69c4d624f9e598a249c4134038ffd62abe47d040ee5848ae9'
            'bc635996603807369d97066986af9f2ee89a201ee380bb23ebf80f64c4b0f7ab6973c337f481a57c3d19a8dbcdfc400546bf1df56d5633cadcf82cea00f58698'
            'bfba1035f62d1e4a4a278a51bd604dde19a7f9c183e5ed3c4c92436f40d11fab76c2a253fdbf653751e7e8f3f0e44b53e560502cd053e53e774ad45d55059cb6'
            'dd3a40a4a3fd7fa571895b8d52d3fc56d5b68de295d27a1744e0b2d0691a28b1c3fdd28e77289ded1980ca520ffece33d43a8b1a229babda2abca43902b98756'
            '0f7523d5d61ab2bfd1cb85fcf82721005844ea4794c12c463e0cb1a59ccf7d90c3dcd303aae662aa31868998b11255e34ad4b76f67c53857d3eabc5986528816'
            '8504bad86e0ef4393a2ea5d0085bbe32f22746051356eab6a13f7a6ab97a34544475784b30fb57dcc9a3beeebb241bbcd0c466aa07f56f4916632d64cb84d7d3'
            '5e5670f621f0bd29a6a079af17331677d95c74ec300c96839a7e5867d595016f6db1a9f8cfae93fff92a1874f5f3517418b3101a8da70720bcd8ea12d661a27a'
            '941315a7c3600890d7f7067a7f2cba3a589a74c0aa75b407d81cae465cb103050d41ea68ce764b230610990426bb23e0eeece2b9c5560833cf14848d81addd61'
            '7e85f762215dfca58ec7f48efbc356d73e6257b4bc8f236c1736d46cb974fa250b81ed8f6992169ce15c99071711ed15af2ebd3ae2ab09f18dbaf4044c981a1d'
            '02ed4c2fea959f6d4d3553f4431174709d0cb8c8c6bc4ca042b69a0f605c7ff052b24492e59944f6ab5cb50ecc6bc1e9596756fe8a9565ea334c2a0a27d92b62'
            'f1929c11c2b36b472223448cd4ac32552439116cadda961ff70604001118c79d49823742231952807186baafd7523a1b39e88b8f9a408bc89a4a82bba40004a4'
            '42edd431dd780f146449e5139a5c82b7051a5f5cfb27ee6d66a709362d1da11a8bcf415e49cbd9ceac119e0ebd939cad0535353c8aff6262aec158549d1694ad'
            '3d1f7d57b978f6a7f0e45e040aca9b5f70906c33915ebd7dfb328ca2cab4cebc1a1362fc3d0506966a86b7169526f0270457f4e411cf11fc2160183825439598'
            '9f8edb5a5368e57ece519c4da624c2bc0e342f306417079a3117d1c19a9991fd11a1c20c0ffa0493f4d75126b3bda4881bbbbcbc620edd938d6efab8c489be65'
            '095d3a070a4403346d8e2e563f98a34feb4db4b2bb8f0cbfa495bc0cf63f7d38ae843d2dde6ba684c25595fbaed1024743f86a95797151d01b64c772cd74cbfb'
            '678d1916c5548735ae6671f72b369f9d5142079da0264f3b0e990235237150da9d162de5b9e9dd112e40c450443387426bb77621e08ec11d72c480bfa7f902d7'
            'c611203d02e7f20f5d82775eae2ea25a2132d1576dd47133025af0c43513b160dbcf388285afbed8d326b956f49e8f93af350301ce511324d2e2f035f9b06ef7'
            '685607bf4f43c50dfc66ba2f57b27f2510a638df5f2f6b653a2c2df234a20e37c2562bd20156ea9d56aab72569833b5edb4896bd1927b9b4582fdaee2cefe3ef'
            '91ac10bbbb1cf5b37d32fcf1c524961d42ae818b35b04fc99825c4dcc0195426dd0a06c991cdcfb54a124f47a458cec72a5d3f4263c6d02e6c41aaaaa22ef38a'
            'bf6cda77dd90e61d7d27035cab0dc0b1dbfb99503a20b83cc7d9f087f73cf52fc410f9fd224961a20f49fabdffe9d355a2720432007d4e865f9184bab5b4340b'
            'df5408e82ec390181016ed24f332bbe06f3938d5aeae1ced4cc4696433b948a9283cbc75b27cb9dc58b0b9a50f6b8a5727700514164254d3a80094107e7fac24'
            '2efb10191bab5f5c2c7fbeb1e19d88be25470273b9b70fe6fd46662683355e023ddab0b173605aa2973cb0eca34cf80a9ef5f8850bf9a2c2097eb8650f912061'
            '672b2cbf2962ea6a2ab692dfae50218d5e4af1e3ff26c11e49ceaf8e3b3434e423f8453be62c62b2249d33ee3faefa74f18f060e7133350ed3e22c88f459e1dc'
            '5f0ad7c3ddf917d6e650d48e08b0e50d9b043345a12f5790fccf2e477399ab1485ad434d9565f4c1acbffe3ca507b703f096c718ef7404a7b4ccb0878511bdc9'
            'f92274bbae6dbf786c2aad9392471b43602c128b0629c74dd9a6a41bd7684e23e7293dd24130c5e769783d7f56ddfb785fc55ac0229da34feb02ab6d5e9fccbb'
            '70999c026665f5f5c87fa9c9f7dd882f5b0f447746683cabaf9cc20ca880e77323c20347909058b907a5a7b58f48cdf27a2e535908b428f45a8cb975250bd30a'
            '5060cfad0c57b403ca1475b6bc21e0a3f8fed89293de400288e1efe3efbf194cea44c7566b0a8bad330e8aeedd4c05ec0e2987bf0a98fe678d5a35d1ab6c4b2f'
            '94461a8dfac7537a7598c8c01537f8a3fbd5927b40b87e88dc1b2b7ac3835fa07d3932445c446dfce3ed4b901fcad5b28db888646b66370e75c60eb5116c250d'
            '8a98fced0858030d53102de16d05d81e22846617d8f0ee94f4a95bdbc099dd10d14653e7daf7ff30f06092c72d1d9ec7d9910f25d3859b18e96c0c6fac6dbfe2'
            '7a56f9575205ea7b4adfbf6bc7c89f482bf0b4a2b07a6d4804f3aec35f74ba384ae0fb9dce406e8013dad2b7bc17ce10b9b02d8126436fbac10e4290e47b3f69'
            '3e2ab3cbae57a8fc7c598a093b303969b2cae4c13303af6bd1d9aef2c08f21639408b1ce6c8c1a06c2aaee66538ab6495f544d0507426950f453c1b3b1ecd0c7'
            'caf78bd24cce9ff4e8c890d0bcdc29e4a6ef70488ef5e1b3193105d233c59aad04d253b558a49a64a8028b5e9f82ff5ba5f291eb25c50b8c58a2e3c42e6a4a41'
            '3cf40929982cb874e8d32b31e7164e093de52653b9b1a8c8fbd0393b8d397730685c0c93411cbaf671813f2736b1218716d169d159e17d94e89a9a9e4c7121fc'
            '7a1c64cee1551111c565d99798cfccfdddc896c229acba0a746c2a3dc4ee6bffc35e4c65163a9eb1949279223d9d0613aa000762bd542dec64f7647664992942'
            '79e7a384c5f94eea5c000aae5c362fdb5939ccfa5ce2673245160a39437fc17da563f35a5925fef2ef466eeab176f4a74e85379c591922261e33c3e292dea611'
            '38ed888491a14cb5ffcbaf7292ef3d103784261b046366f1647de85d9b678abd2778666dcbcc0a177b186749cacb7d760320bd52a753b116b2397a5972b157fa'
            'a326e784baaf09ee8ff5427034e7f577a7d1341ba6728f0e17565d96b53a506a592050ec4a6bad942a0cef85bafaba6eb6872a627b9619608369ba344b0e5417'
            'd7621361a7b569229696d074e32e2608721d202a9d461a6d8ba937449825bf986872d563175c02c69a2d09e7f6a7815abac905a792cf000ba4853f816b7c209a'
            '8f5e4052c0d3caa80f95a7d3eba87b83635f8221a585e07f55b29bc6c4ca3360d88eaad44af9b1dd4637a1164b2a34837f6788663fabb197782714943040e97c'
            '4af86ba03490ff92b713aeeea18242074ed973e171413dfed2694592d8c043152e287473fdc694e9dc5a3db03435eb2550d702c796bf2e011837a5c7cd44faf7'
            'd7ee35c9a18d0d7b1027c2fcb63383cb97bfd6372e74c3de3579e68f4b5db7795f30fa2106e42d34c9c06b380df3611f7227c9c55ea970810eb83bf2ab08793f'
            '55f911ee4efb8096f8656071f4db14f835a06752af9d341f33a4acfbbdcd348626744a7e8eb0cedd081b56c47103faa480916446041676b39b04ec337796f8b9'
            'd8f7e3551f1480c3dba673c3e2167073e527fe2092f38be8023d348f9ad0d62ecc2614f2639e565684c4c643dcc07e86d0881c9add9309dcb99815d623bdf872'
            'c0518c0788d17b1f0ecdd1198532d85d67960c0c1193323575111ee8d1ece0f5c8d506f8bda9dde20649affd55dbfb4e6815c85fd77bfaabe35476bd2d6fca32'
            '0953484830c4b6427949a05d1cfd0e8f15711f2f5fd9bb49a6314d11882eb47bcf9d8a3ef8fc02805d280f7a620be12b3e54db9d7baf29f7ff6ead1e8a036411'
            '48c4ac22976538872408f53dd98db1cb73ea53bdb005b0cd398e7f9f93a55b980731b9eb2d187b5c78353b885d8dabe9cd4199572cb92be0997424df680251e9'
            '500c78c53c1e5c28dc6e4928ae43b8a5674dea7339bf264b28ed0cd02d3eecff793a7be28d0777a5065c4de3850bb23db5c1eaa5b968fde9df0b61a83318e214'
            '77b5d4c98995525fd2c477026eaa097ac102640bf52fbdf4283ff49509827b14ee1fb4695739d3a644b2f4fd8e0d0e6c4a4576cd10e7d191c56b95a0204d3ba9'
            '00eadbc660a56886eb52b92dc6ee0ce2f8cef98a147ef144447e671210b3dce17341ef3633e450ad35d0dc73f40e77410743b8d1cdefef790253f1b3befc4443'
            '33df452dfdef9df0e55da7ece9fb00439f728fab9502093b6b2702ccaffa941d0756c73feb73ef1ebe366071ed92f3d852dec8abd006f5b0942b08db65453ef5'
            '9f7063479a272613fc045994f754656f8dcfc0711c239e133ae1af8d5f8ec2a31ecbc14e8f38c24796eeef5b801c3b0f1ef513abcc697ec61e8bb4b440f95401'
            '56d50acdbd08a0cda2a7412a6a48c5a1f5e84c5679fbfb1e24b413f8d2f43d3981f320d0bb59de0ee0a36c8bbcce107fe040c008ce867d04099d9de5f15a2852'
            '0cddf5af16e517e1cd7d6d74379b66de2e6adb3f5e307f345bca0baf7789b3cf7d699878af4968dded22dac0ba6fe8bed8fca36d0866e1f415f02861cf34f110'
            '7bde0115226e8642c80436dc3cfec94076a0bb55acde1a556c9cb99c0a70188b27b043d94e197c4f0047c54186ba2fe71569688b2d18d71c726ae0614c3a165d'
            '98071e1ed321393a42c62052d89ed0dbd23fccd8fe0e18a8990fc6bd4ee3ee2f81f450bb9d6c848a25ff21e1a6fe48f61bf35da1e3c55b0ccbb08ad7c0479054'
            '9da520f58e0bb21376116d40c4cc932a21e65941ef7d53d016ddc189c9ff4d5a798efb56efb73240469d608dfc57533ed839a77c10b5a9594801a5fe0a57d326'
            '9b0ba0ff0f8d9e5f5a555bdb464dda3facc9038674dbd1ae3159e3a9799b3d3af5ce3e0bff611f94b1fda2b46d8e7318932bcaedce00a97a7017e5b3cf1d7558'
            'e829ec3e717ec39c8743767e0d64e7740c8745a3f759bb0f0a0a6b2c7582354510b55894abbd82583a0ccf40d26d111c9635316f5092c0b8ad2cd201c72524e2'
            'be96abfe6e8292c725d772a52e8c9750f933102c395a8771a73fe79b6c0fb12c343cfa4c90388184a0ba9862d4887aae0933b01b39ecbca5318ac7d488eb56ef'
            '77c15d92de79743f71c817068e2a97ce28cf5eed6b44fba34ee82b828fd9bff3024d734fa3e1eff7eafcdbeb3cc7c4e6965bfadb7d3193bda5b950d86d507105'
            'f144a1e2e06ae8615b560c144eaf7197eaf03b2ce932a451f69a2cc7ac29815f5f071fecf05fe130b319318a80b4e7e1c872ab2ff9dc456f1985ba1c47b3ab07'
            '88834cf5f878170ebb9ae3915057cd901de21940d583973a27be4fcd83efc56c8882c087dee2921168ebbfde7ec0e9b545b034a58cb8c267b3f710d7ebb11578'
            'f95ba4e4657f00aeb283e13aa4f1b8c8a608a0ffa9fb713b1e9703eb4b2df8fe88f27334c8b205e3cede313764a05903d1dbc399cd505a397c9a61430d0b6628'
            '089e7476adf9ad23c1efb7b67ca9c14ca85bccce88e697c93ace6dbdef6d007c39d9758cfcad8858e2496ae8ed25755a07c8125044c605b129bbd60961e985d1'
            'cf94f5f5298669d6bc590ac53bfcbb8b514fb5a4fdb018fd997a9141a5c032efc0b0a1caf13979b928adcd87bf03af6e04f7d8199633072743319b2e1fcbbafa'
            '2400518b780147c12482b8862bb2b8c03dc1ded8ef7568992567fd0ddd15d456ea9a2065ebc37dfadb478c3805df247b15f7af9a6fb9949737d83edc19e43ccf'
            '05174560fd07c5e84446f58f43ed9fa3a5e211b687cd8a7c688af441226b1f6da56dcb28d321bad2574636d6113141aa9867af28d940aef38dd5891ff5795a31'
            'c49105a3a9546289569313b1d459df6e7c13a6e7d7b2511688a22938df5a4861b82a6db6421f451a07d00506fe4f23094b2bec03e4b8c93d95f4899ec2cb9606'
            'cb2c4e848a85abe97e4f58f7850246bd87fe50198f59a8fdb8e809e2b5ce84cf3520ecbeff1fd2192b87548edafdfccd6673648248580b1378cf2a188e8fafa9'
            '71973deb61122c25199a75c8d1d4894d9bec52a64a5142f2dfcbf7ab1e080a5d9fb4925a47517e04e46f9c669a63d5b1e615fc470205c4413112b2e80cf8ecc0'
            '7eafa93c2a611fe2870a0e13c05a7c273b7556749effa318949e7e73dd04f53a7b48ee5e4d469c05802e06c36e1e3714ab4b6172f549d8062dd1ad4a199425db'
            '05bb76cf22caf97091b3887ea7eef22a7cf2c416906a64b56733e70b48213e401e1b29f52573aec2fbab41f2a2c6411e1390819d88c2b42c8e3255be463a87df'
            '9979c53f285b78ac32d32dfe79fa332ff8215b99abce0ee3c3ef7cbcf961aaceb84e56cb5197369cd839c8de8b285d119e1c978b31cd859fc7000e21f0f4d995'
            '9dabecafe5263185169ed7012add134a338e93db33c98b354e7a66477d2b6b369054c64f7470766a1092d6d8b97ea311543a4152ecc10a2de375b36101f8051d'
            '203bcfdf78f4608f39238f668aa5459ade37e58e6c46ea20eb340875490a8d6b7a252a83bc3ae7f69ad8e5e8a9533647a77deee925d29911e25ec841cdf701f8'
            'e9c361be939f7213f8b5929b2b14d4449ca01fbbcf699df8b93913633d8d86ecde6c1c9b33cd3c4778194bbd7cd99e69e55b64fe4cc30fe48c01fc1db2bdba08'
            'f21c36d4e2b1440c6bc320bf12f3e0d66b858fcb4373f47e137c29e7f4eee0b7801cd553ca95e74c252766a0e9429b75e115d77e4ebe25b42aae6661b95f5e5d'
            '30ae2fc15e67a80190bed4ef313de6212a254c393c035a417b3438eab370d10c303e2fb5421b9fbbcead0c8ea8d1fe2cc26d32e7139acc9a4433e8d307a68544'
            '359284612932f928efe98202171536f7d0c8d0d5a4093ba8aca8f1a99698a8e453b69f1d587b4552ea470895f0b2cc0def0e8b6c7564d0dc50b150be045dd975'
            '536fe4ae4e79854b87697700e3c410b536922d662676343741ed907497edcf6382ad4032be367428743d92246a94b72f7418ec1f01a903c1be406fa14b03948f'
            '01acecd4b29659ef386f1fdac18a777106b467ee36adae675d940ad23e7f7c80cf2c2fec4dcc390d0299171393930527fe7fb8ed9a97e30716f2cbd002c32322'
            'a5c0a22763bc47493bea9f1a0309358c7b41b80fda8981bf35be493a04d697d497453ddea96285e44d36df7ac9200ed622752540dfa468f88c502f186781bf50'
            '88cdbc58830f6ffa5530f647401acf890b123fb7ee808e591116d93cbf9ac2027373decf05b46e18101892af91285de5eb09152c213210c540276887d2e316f1'
            '7ac460268ca8cad75f810249ae792da1e06266dc54cbfd6ef7ac396ab5a23bbdde91bd6d89c80bb5a4a3eb6b5a58bd2314ec28478d86115f4124e92363ccc3f7'
            '6aacddeed79c8dc74bb6447e3f7c378bfbf897b83b06e5acc6262a98f83036d982d337fb54339fb86e3decc6ea7b1f562a054a816d24d94c33821f8f86818c51'
            '15ef23a6c39d6397018d554a83b5fbc0e741caad5cccda0f9ee975d76be3511ca2c17db1cd812f8f5dcd501d6bb9a0d79e3305063ae059e35031dc92e1443356'
            '49f5bcb3acb3debb1680862ea14e90144a4bc09551e6bfe8c6137fcb5ae48c02bd43f79898efa4e59907d483c87e678ebf2b23baa8f045cd560a1d6366aee361'
            '7b03b892f4368450861f2850f441d478488a3c2e68cf4cff778a730a2a5ba9751739e08a800e9d3724b12d29dfa41e6d1c7e2094972dd213fbac94e6f98a6c7b'
            '28c5b74878e7831a81a0bbcd86d607f34fd68561037d4a05e28d2ede1a13a1099d14af1c3950914e843b0c42ba1832fdcce67665d8e7967135fa8c1fa711f9ab'
            '16ee0313b66146e6cb4eb6d5fd5e214b6f37ec0efdaec9646aee23899895ff669a4615c23343c209cdc14e029fe69df543e6502ea3e3547a2d2123b0ec201d75'
            '1ff7409fcfd1242a15ec21aa000d53d648b5bcd60ab6cc9c2c37a8212f4e5137c3dd41edc361c5be140a02faa14c699a2db12674681bb21d99d629a1291f3aa7'
            'bcb7b5fdad0d4986355df3d7aaa6fc016b6ffa3ac06a1fd91fafd2bdcbe802aec6a6cdaefca70b2557e9dcba25f466c156a049c7e0ad97cb6a365b1290e95c4d'
            '87018cc9ef366d6b0a5cc8108455d5060aaf42874cf24766d4ed071c6cc1fbbadc31ba71dc493dd5e3bbbf9ee3d8a00b2a96ba973ef07798a875eda6b17ca9c6'
            'ef3173ff76da27ad9d8d381467a148d21caacce0683a8d621a27ee79802097a1d18025cd984ae21619b1f61a35471c02d0c5d716064af4af8ce60c81d379ce78'
            '28b7e260a42ceafa0d431ea4baeb717a2c2d9a17991f3d3b07db3ebb75ca9030025bf9e17ad262bb6602a35569b61a2c0556168bbf572b66e574ba4d654256dd'
            '3b176944c7ce3749a026caa2094e01ee3a989d99ec435859e664e2588408145f79d4ea7d164bccb39bfff68b0e75eb6ee161d9e8e02cc0a4edf4ecea8ea3cc4c'
            'ce7d93509961e3fa33aef32527e8e98cbb1362e204ea724c8d54450c614e969452dfc43320dd8d0462b647a0c1b5d7057ad7e30a05ade68bb9a82ca7bda8b2c8'
            'bcacd24c2830cbd4aaf438d747f15f041d0ce880818584b49f831eb12371fe5e2345ea3847a63023b4ab6c2be24a91039cd7e90ae33b259a397b88a3b1eee330'
            '6a53a2bb62f76fb1bb86ed21202c44d833c5565566f65993490aeb9a6e2f5afdc0839a916c61f799861556f1fd09bb801ffbac671357e9acaf8e43d51c0371d7'
            'f1f9a95089eec8c59d9913f19d2b3fadcb01e52fc3ddecd5d232ce0f8936cc8c0b1a232ba15fad106300881ee064f87652e3242334dbc00bd80341e4b7378714'
            '6006c95686a48a609f6b1c978f32154dfc586a82eba41e994ab3760ec86c1a96e33d518c0457505078c94a165c31505a53ba5fdcd2f22183451a59742f74161f'
            '862ddb46aba483b3dbbab0fd4943206dd2849cf8d44a22962d12e6f1eeadd7e04142660b7120ad512489dc6142fc8067d19c0c52d25d9f964f3e434453a32eb8'
            '82c23712f0257609afa9b770b931171d778b6e48612eda26cfa88ff9ddd1f6e4a26a945ebdbc4112e40be8b55d0de8d52b4c5e353f4b29cd07b895ee590771f3'
            'fb4a3154d227d6e6b0ca9c03aa29d2bb7314f8e74a1d8a7765a777e831b60990a2b9d4807a7baaec4b0b9c16f61f9214611047fda33760ff95aefa2d03581dd5'
            '0c1fa1394e62865ba8bc3a6a5e37d78b0cc5ce81ea758fec6e2b26abc462976719785aacbc5bdb3be92a67484b643526d692567141a21df5692f4bdc4b6485ca'
            'd86a50edb5f19e1a8962746c6283d7a3697329ad741b0f95cbda2e392fe449befd19e6f1287561930c1ea465bd24f87b0187ffc98f6844a0b6d18c0d7b9d6521'
            '58053a5c887bfdc141d04c15fd2865aa9f33dd2221eb5cd13fedfd93b85596f93d8f9cd011cd89f0356541bc3e28b831f4185cd7165d6eaece793618121891f5'
            'b90889ada1509200b6ce59d5d6498a1640a01402b4ea908540d55bcbd7d773d24949fdd6de54febc064b70f5846a103ce304bb7ff3310847c371489cb9a02544'
            'd7a5ab241d701f61b8e9ecde1959b77cc11268b32255d0ba5aa9a5905bb9ee76d26319ddc817052db1d53b3c622a7695af06ca59697e7f516ebb9557399dc68d'
            '081b4fb95965c298edaa5bd3b40b3d366f8a287de666910d028c2a060ea71b47b9dcc93798f48081f88c0ae02669c4ebd24df6d4eb907a2a77dc86c5601c3ee1'
            '5aa2d959c30e16de97829a075aad75e7b100388ce67dd32cb6d8a80398f11d0b79124dd694e726d9b563a4875aabc248064d5be6971cd3788eb3cb1d2c8c396d'
            'e636e11a6d1af5676288bbbcad3a1a100a6107f8a23127df20469ec1eab1d97c0cdf96ff3273eaa17a1dbd860fd8d24dfb819a11312b3ecbec561cfee5dde0b1'
            'ba7b7a053c78bf1e403c2fae293a128cd2b5dd24142fd362c40296c8c8fbdee28a5100498226f27f713457c1953ee846b3a02ad2738f1d697977f443e780fc2a'
            '56112d4cfafcbc62604fd9ca02f89f68d88f0fe8abc1cb951d82295138dc6eee26f9251c82c01ed58a54a3e80ccf69e7408aae63f63f21e05c0c6381f9cc2790'
            '5156083c4e764bf47d46c6bb5fec958a22f88c4842c4549d6992e663ff0c7caf9af616c0949f0905d93c768005ebdfc39b6a129ef2a50e5f9dc600a34ab9ec76'
            '310654b8bb11aa1af48d6fae21d0c6bcfe9f06c27828274c5749d0ab0d759e77441e8b5323b8c6665b23161c9d35c4a9743948cc1b474deb3b1d2c98752cbd97'
            '389f51ba3943815f7cce13f6029cb5b196edbc9c27245f7d96ccb3231b61f76522d50e9010e9ead73d968266edace559c8f783738ee0e9ab8290fb324a230bc6'
            '9193db6debe578bd69c338b24bcfa26e0ae719a78c5f63b442d02d7790ee59397eeb85fe683ed96ad053ab784c9860295c0d149405cb826031b6eb129ca45a0a'
            'f2748495022b16ef93835b34bba1086b415bf90833836b150e0cae2652f6101c337895699476eb98a9ba5cb2eca9dfe9c9bcc2a23cdbc31bc402ab498fac48d4'
            '0f38464e82acf4324447667855ce6fa7188dae593e209edc24ffb35a07f3e5dcc6ce53db52d641bc0c2675461ef8a24fb181d270e6fa373c7ca04665de0f7850')

export KBUILD_BUILD_HOST=archlinux
export KBUILD_BUILD_USER=$pkgbase
export KBUILD_BUILD_TIMESTAMP="$(date -Ru${SOURCE_DATE_EPOCH:+d @$SOURCE_DATE_EPOCH})"

_aufs_patches=(
	######################
	## Required patches ##
	######################

	"aufs5-kbuild.patch"
	"aufs5-base.patch"
	"aufs5-mmap.patch"
	"aufs5-standalone.patch"

	######################
	## Optional patches ##
	######################

	## Add support for nested loopback mounts in branch-fs
	#"aufs5-loopback.patch"

	## Make /proc/mounts show all mountpoints
	## Does not exist in the current tree?
	#"proc_mounts.patch"

	## Prevents assignment of 0 as inode number
	"vfs-ino.patch"

	## Keeps tmpfs inode number low
	#"tmpfs-idr.patch"

	## required for LOCKDEP
	#"lockdep-debug.patch"
)

_aug_colorize() {
	# prefer terminal safe colored and bold text when tput is supported
	if tput setaf 0 &>/dev/null; then
		_MAGENTA="${BOLD}$(tput setaf 5)"
		_CYAN="${BOLD}$(tput setaf 6)"
	else
		_MAGENTA="${BOLD}\e[35m"
		_CYAN="${BOLD}\e[36m"
	fi
}

_msg3() {
	(( QUIET )) && return
	local mesg=$1; shift
	printf "${_MAGENTA}   +-${ALL_OFF}${BOLD} ${mesg}${ALL_OFF}\n" "$@"
}

prepare() {
	_aug_colorize

	cd $_srcname

	### Setting version
		msg2 "Setting version..."
		sed -e "/^EXTRAVERSION =/s/=.*/=/" -i Makefile
		scripts/setlocalversion --save-scmversion
		echo "-$pkgrel" > localversion.10-pkgrel
		echo "${pkgbase#linux}" > localversion.20-pkgname

	### AUFS
		msg2 "Copying AUFS build files and applying AUFS patches..."
		local aufs_srcdir="${srcdir}/${_aufs_repo_name}"
		local kern_srcdir="${srcdir}/${_srcname}"
		pushd "${aufs_srcdir}" > /dev/null
		cp -r {Documentation,fs} "${kern_srcdir}"
		cp include/uapi/linux/aufs_type.h "${kern_srcdir}/include/uapi/linux"
		popd > /dev/null
		local aufs_patch_fname
		for aufs_patch_fname in "${_aufs_patches[@]}"; do
			_msg3 "Applying AUFS patch $aufs_patch_fname..."
			patch -Np1 < "${aufs_srcdir}/${aufs_patch_fname}"
		done

	### Patching sources
		local src
		for src in "${source[@]}"; do
			src="${src%%::*}"
			src="${src##*/}"
			[[ $src = *.patch ]] || continue
		msg2 "Applying patch $src..."
		patch -Np1 < "../$src"
		done

	### Setting config
		msg2 "Setting config..."
		cp ../config .config

	### some initial configuration
		# (we start with the arch config as a base so I can keep track of stuff easier)
		scripts/config --undefine CONFIG_LOCALVERSION_AUTO
		scripts/config --enable CONFIG_LZ4HC_COMPRESS
		# from patches
		scripts/config --enable CONFIG_FUTEX2
		scripts/config --enable CONFIG_VHBA
		# kdump
		scripts/config --enable CONFIG_DEBUG_INFO
		scripts/config --enable CONFIG_CRASH_DUMP
		scripts/config --enable CONFIG_PROC_VMCORE

	### AUFS
		scripts/config --module CONFIG_AUFS_FS
		scripts/config --undefine CONFIG_AUFS_BRANCH_MAX_127
		scripts/config --undefine CONFIG_AUFS_BRANCH_MAX_511
		scripts/config --undefine CONFIG_AUFS_BRANCH_MAX_1023
		scripts/config --enable CONFIG_AUFS_BRANCH_MAX_32767
		scripts/config --enable CONFIG_AUFS_HNOTIFY
		scripts/config --enable CONFIG_AUFS_EXPORT
		scripts/config --enable CONFIG_AUFS_XATTR
		scripts/config --undefine CONFIG_AUFS_FHSM
		scripts/config --enable CONFIG_AUFS_RDU
		scripts/config --enable CONFIG_AUFS_DIRREN
		scripts/config --enable CONFIG_AUFS_SHWH
		scripts/config --enable CONFIG_AUFS_BR_RAMFS
		scripts/config --enable CONFIG_AUFS_BR_FUSE
		scripts/config --enable CONFIG_AUFS_BR_HFSPLUS
		scripts/config --undefine CONFIG_AUFS_DEBUG

	### CPU optimization
		# I want to be able to slap an HDD with this kernel on it in just about any machine
		# I'm very, very unlikely to encounter any CPUs older than AMD K8
		scripts/config --enable CONFIG_MK8SSE3
		scripts/config --undefine CONFIG_GENERIC_CPU
		# I'd add an -mtune=znver1 if I could

	### NTFS3
		scripts/config --module CONFIG_NTFS3_FS
		scripts/config --disable NTFS3_64BIT_CLUSTER
		scripts/config --enable NTFS3_LZX_XPRESS
		scripts/config --disable NTFS3_FS_POSIX_ACL

	### Android stuff
		scripts/config --enable CONFIG_ASHMEM
		scripts/config --enable CONFIG_ANDROID
		scripts/config --enable CONFIG_ANDROID_BINDER_IPC
		scripts/config --enable CONFIG_ANDROID_BINDERFS
		scripts/config --set-str CONFIG_ANDROID_BINDER_DEVICES "binder,hwbinder,vndbinder"

	### le9-patch values
		scripts/config --set-val CONFIG_ANON_MIN_KBYTES 0
		scripts/config --set-val CONFIG_CLEAN_LOW_KBYTES 262144
		scripts/config --set-val CONFIG_CLEAN_MIN_KBYTES 0

	## Fill in remaining defaults
		make olddefconfig
                diff -u ../config .config || :

	### Prepared version
		make -s kernelrelease > version
		echo "Prepared $pkgbase version $(<version)"

	### Optionally use running kernel's config
	# code originally by nous; http://aur.archlinux.org/packages.php?ID=40191
	if [ -n "$_use_current" ]; then
		if [[ -s /proc/config.gz ]]; then
			_msg3 "Extracting config from /proc/config.gz..."
			# modprobe configs
			zcat /proc/config.gz > ./.config
		else
			warning "Your kernel was not compiled with IKCONFIG_PROC!"
			warning "You cannot read the current config!"
			warning "Aborting!"
			exit
		fi
	fi

	### Optionally set tickrate to 1000
	if [ -n "$_1k_HZ_ticks" ]; then
		_msg3 "Setting tick rate to 1k..."
			scripts/config --disable CONFIG_HZ_300
			scripts/config --enable CONFIG_HZ_1000
			scripts/config --set-val CONFIG_HZ 1000
	fi

	### Optionally disable NUMA for 64-bit kernels only
		# (x86 kernels do not support NUMA)
		if [ -n "$_NUMAdisable" ]; then
			_msg3 "Disabling NUMA from kernel config..."
			scripts/config --disable CONFIG_NUMA
		fi

	### Optionally load needed modules for the make localmodconfig
		# See https://aur.archlinux.org/packages/modprobed-db
		if [ -n "$_localmodcfg" ]; then
			if [ -f $HOME/.config/modprobed.db ]; then
			_msg3 "Running Steven Rostedt's make localmodconfig now"
			make LSMOD=$HOME/.config/modprobed.db localmodconfig
		else
			error "No modprobed.db data found"
			exit
			fi
		fi


	### Running make nconfig
	[[ -z "$_makenconfig" ]] || make nconfig

	### Running make menuconfig
	[[ -z "$_makemenuconfig" ]] || make menuconfig

	### Running make xconfig
	[[ -z "$_makexconfig" ]] || make xconfig

	### Running make gconfig
	[[ -z "$_makegconfig" ]] || make gconfig

	### Save configuration for later reuse
	cat .config > "${startdir}/config.last"
}

build() {
	cd $_srcname

	make all
	make htmldocs
}

_package() {
	pkgdesc="The $pkgdesc kernel and modules"
	depends=('coreutils' 'kmod' 'initramfs')
	optdepends=('crda: to set the correct wireless channels of your country'
	            'linux-firmware: firmware images needed for some devices'
	            'modprobed-db: Keeps track of EVERY kernel module that has ever been probed - useful for those of us who make localmodconfig')
	provides=(VIRTUALBOX-GUEST-MODULES WIREGUARD-MODULE)

	cd $_srcname
	local kernver="$(<version)"
	local modulesdir="$pkgdir/usr/lib/modules/$kernver"

	msg2 "Installing boot image..."
	# systemd expects to find the kernel here to allow hibernation
	# https://github.com/systemd/systemd/commit/edda44605f06a41fb86b7ab8128dcf99161d2344
	install -Dm644 "$(make -s image_name)" "$modulesdir/vmlinuz"

	# Used by mkinitcpio to name the kernel
	echo "$pkgbase" | install -Dm644 /dev/stdin "$modulesdir/pkgbase"

	msg2 "Installing modules..."
	make INSTALL_MOD_PATH="$pkgdir/usr" INSTALL_MOD_STRIP=1 modules_install

	# remove build and source links
	rm "$modulesdir"/{source,build}
}

_package-headers() {
	_aug_colorize

	pkgdesc="Headers and scripts for building modules for the $pkgdesc kernel"
	depends=('linux-kitsinger-5.14' 'pahole')

	cd $_srcname
	local builddir="$pkgdir/usr/lib/modules/$(<version)/build"

	msg2 "Installing build files..."
	install -Dt "$builddir" -m644 .config Makefile Module.symvers System.map \
		localversion.* version vmlinux
	install -Dt "$builddir/kernel" -m644 kernel/Makefile
	install -Dt "$builddir/arch/x86" -m644 arch/x86/Makefile
	cp -t "$builddir" -a scripts

	# add objtool for external module building and enabled VALIDATION_STACK option
	install -Dt "$builddir/tools/objtool" tools/objtool/objtool

	# add xfs and shmem for aufs building
	mkdir -p "$builddir"/{fs/xfs,mm}

	msg2 "Installing headers..."
	cp -t "$builddir" -a include
	cp -t "$builddir/arch/x86" -a arch/x86/include
	install -Dt "$builddir/arch/x86/kernel" -m644 arch/x86/kernel/asm-offsets.s

	install -Dt "$builddir/drivers/md" -m644 drivers/md/*.h
	install -Dt "$builddir/net/mac80211" -m644 net/mac80211/*.h

	# https://bugs.archlinux.org/task/13146
	install -Dt "$builddir/drivers/media/i2c" -m644 drivers/media/i2c/msp3400-driver.h

	# https://bugs.archlinux.org/task/20402
	install -Dt "$builddir/drivers/media/usb/dvb-usb" -m644 drivers/media/usb/dvb-usb/*.h
	install -Dt "$builddir/drivers/media/dvb-frontends" -m644 drivers/media/dvb-frontends/*.h
	install -Dt "$builddir/drivers/media/tuners" -m644 drivers/media/tuners/*.h

        # https://bugs.archlinux.org/task/71392
        install -Dt "$builddir/drivers/iio/common/hid-sensors" -m644 drivers/iio/common/hid-sensors/*.h

	msg2 "Installing KConfig files..."
	find . -name 'Kconfig*' -exec install -Dm644 {} "$builddir/{}" \;

	msg2 "Removing unneeded architectures..."
	local arch
	for arch in "$builddir"/arch/*/; do
		[[ $arch = */x86/ ]] && continue
		_msg3 "Removing $(basename "$arch")"
		rm -r "$arch"
	done

	msg2 "Removing documentation..."
	rm -r "$builddir/Documentation"

	msg2 "Removing broken symlinks..."
	find -L "$builddir" -type l -printf 'Removing %P\n' -delete

	msg2 "Removing loose objects..."
	find "$builddir" -type f -name '*.o' -printf 'Removing %P\n' -delete

	msg2 "Stripping build tools..."
	local file
	while read -rd '' file; do
		case "$(file -bi "$file")" in
			application/x-sharedlib\;*)      # Libraries (.so)
				strip -v $STRIP_SHARED "$file" ;;
			application/x-archive\;*)        # Libraries (.a)
				strip -v $STRIP_STATIC "$file" ;;
			application/x-executable\;*)     # Binaries
				strip -v $STRIP_BINARIES "$file" ;;
			application/x-pie-executable\;*) # Relocatable binaries
				strip -v $STRIP_SHARED "$file" ;;
		esac
	done < <(find "$builddir" -type f -perm -u+x ! -name vmlinux -print0)

	msg2 "Stripping vmlinux..."
	strip -v $STRIP_STATIC "$builddir/vmlinux"

	msg2 "Adding symlink..."
	mkdir -p "$pkgdir/usr/src"
	ln -sr "$builddir" "$pkgdir/usr/src/$pkgbase"
}

_package-docs() {
	pkgdesc="Documentation for the $pkgdesc kernel"
	depends=('linux-kitsinger-5.14')

	cd $_srcname
	local builddir="$pkgdir/usr/lib/modules/$(<version)/build"

	msg2 "Installing documentation..."
	local src dst
	while read -rd '' src; do
		dst="${src#Documentation/}"
		dst="$builddir/Documentation/${dst#output/}"
		install -Dm644 "$src" "$dst"
	done < <(find Documentation -name '.*' -prune -o ! -type d -print0)

	msg2 "Adding symlink..."
	mkdir -p "$pkgdir/usr/share/doc"
	ln -sr "$builddir/Documentation" "$pkgdir/usr/share/doc/$pkgbase"
}

pkgname=("$pkgbase" "$pkgbase-headers" "$pkgbase-docs")
for _p in "${pkgname[@]}"; do
	eval "package_$_p() {
		$(declare -f "_package${_p#$pkgbase}")
		_package${_p#$pkgbase}
	}"
done

validpgpkeys=(
        'ABAF11C65A2970B130ABE3C479BE3E4300411886'  # Linus Torvalds
        '647F28654894E3BD457199BE38DBBDC86092693E'  # Greg Kroah-Hartman
        'A2FF3A36AAA56654109064AB19802F8B0D70FC30'  # Jan Alexander Steffens (heftig)
        'C7E7849466FE2358343588377258734B41C31549'  # David Runge <dvzrv@archlinux.org>
)
