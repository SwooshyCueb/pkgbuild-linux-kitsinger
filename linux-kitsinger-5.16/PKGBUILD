# Maintainer: Markus Kitsinger (SwooshyCueb) <root@swooshalicio.us>
# Contributor: Piotr Gorski <lucjan.lucjanov@gmail.com>
# Contributor: Jan Alexander Steffens (heftig) <jan.steffens@gmail.com>
# Contributor: Tobias Powalowski <tpowa@archlinux.org>
# Contributor: Thomas Baechler <thomas@archlinux.org>

### BUILD OPTIONS
# Set these variables to ANYTHING that is not null to enable them

### Tweak kernel options prior to a build via nconfig
_makenconfig=

### Tweak kernel options prior to a build via menuconfig
_makemenuconfig=

### Tweak kernel options prior to a build via xconfig
_makexconfig=

### Tweak kernel options prior to a build via gconfig
_makegconfig=

# NUMA is optimized for multi-socket motherboards.
# A single multi-core CPU actually runs slower with NUMA enabled.
# See, https://bugs.archlinux.org/task/31187
_NUMAdisable=

# Compile ONLY used modules to VASTLYreduce the number of modules built
# and the build time.
#
# To keep track of which modules are needed for your specific system/hardware,
# give module_db script a try: https://aur.archlinux.org/packages/modprobed-db
# This PKGBUILD read the database kept if it exists
#
# More at this wiki page ---> https://wiki.archlinux.org/index.php/Modprobed-db
_localmodcfg=

# Use the current kernel's .config file
# Enabling this option will use the .config of the RUNNING kernel rather than
# the ARCH defaults. Useful when the package gets updated and you already went
# through the trouble of customizing your config options.  NOT recommended when
# a new kernel is released, but again, convenient for package bumps.
_use_current=

### Running with a 1000 HZ tick rate
_1k_HZ_ticks=y

# explicitly set undefined behavior sanity checker kconfig options
# this option may be overridden by _use_current
_use_ubsan=

# explicitly set memory debugging kconfig options
# this option may be overridden by _use_current
_kmem_debug=

# explicitly set thread lock debugging kconfig options
# this option may be overridden by _use_current
_tlock_debug=

### Do not edit below this line unless you know what you're doing

pkgbase=linux-kitsinger-5.16
# pkgname=('linux-kitsinger-5.16' 'linux-kitsinger-5.16-headers' 'linux-kitsinger-5.16-docs')
_major=5.16
_minor=12
pkgver=${_major}.${_minor}
_srcname=linux-${pkgver}
#_srcname=linux-${_major}
pkgrel=1
pkgdesc='Linux with AUFS, pcie-reset, futex2, etc'
arch=('x86_64')
url="https://github.com/SwooshyCueb/linux-kitsinger-PKGBUILD"
license=('GPL2')
options=('!strip' '!debug')
makedepends=('kmod' 'bc' 'libelf' 'python-sphinx' 'python-sphinx_rtd_theme'
             'graphviz' 'imagemagick' 'pahole' 'cpio' 'perl' 'tar' 'xz')

_aufs_repo_name="aufs5-standalone"
_aufs_repo="https://github.com/sfjro/${_aufs_repo_name}.git"
_aufs_fragment="#commit=a5c609156cb988491fc5da9dade523846664f3b1"

#_lucjanpath="https://raw.githubusercontent.com/sirlucjan/kernel-patches/master/${_major}"
_lucjanpath="https://gitlab.com/sirlucjan/kernel-patches/raw/master/${_major}"

_gcc_path="cpu-patches-sep"
_gcc_patch="0001-cpu-${_major}-merge-graysky-s-patchset.patch"
_arch_path="arch-patches-v5-sep"
_futex_path="futex-patches"
_futex_patch="0001-futex-Add-entry-point-for-FUTEX_WAIT_MULTIPLE-opcode.patch"
_fixes_path="fixes-miscellaneous-v5-sep"
_v4l2loop_path="v4l2loopback-patches-v2-sep"
_zen_path="zen-patches-v3-sep"
_lqx_path="lqx-patches-v2-sep"
_clr_path="clearlinux-patches-sep"
_f2fs_path="f2fs-patches-v2-sep"
_lru_le9_path="lru-patches-le9-sep"

_zen_gh="https://github.com/zen-kernel/zen-kernel/commit"

_kernel_git_path="https://git.kernel.org/pub/scm/linux/kernel/git"
_usb_path="${_kernel_git_path}/gregkh/usb.git/patch/"
_dtor_input_path="${_kernel_git_path}/dtor/input.git/patch/"
_hid_path="${_kernel_git_path}/hid/hid.git/patch/"
_pci_reset_path="${_kernel_git_path}/helgaas/pci.git/patch/"
_torvalds_path="${_kernel_git_path}/torvalds/linux.git/patch/"
_tip_path="${_kernel_git_path}/tip/tip.git/patch/"
_kernel_dk_path="https://git.kernel.dk/cgit"
_dk_floppy_path="${_kernel_dk_path}/linux-block/patch/"

_tonyk_path="https://gitlab.collabora.com/tonyk/linux/-/commit"

_lkml_path="https://lore.kernel.org/lkml"
_blockseq_t="${_lkml_path}/20210712230530.29323"
_blockseq_s="mcroce@linux.microsoft.com"
_amd_psf_t="${_lkml_path}/20210723093209.714328"
_amd_psf_s="namit@vmware.com"

_amdgfx_path="https://lore.kernel.org/amd-gfx"
_amd_dcc_t="${_amdgfx_path}/20210914235948.893422"
_joshie_s="joshua@froggi.es"

_hakavlad_gh="https://raw.githubusercontent.com/hakavlad"

source=("https://www.kernel.org/pub/linux/kernel/v5.x/${_srcname}.tar.xz"
        "https://www.kernel.org/pub/linux/kernel/v5.x/${_srcname}.tar.sign"
        "${_aufs_repo_name}::git+${_aufs_repo}${_aufs_fragment}"
        "${_lucjanpath}/${_gcc_path}/${_gcc_patch}"
        "${_lucjanpath}/${_arch_path}/0001-ZEN-Add-sysctl-and-CONFIG-to-disallow-unprivileged-C.patch"
        "${_lucjanpath}/${_arch_path}/0002-Bluetooth-btintel-Fix-bdaddress-comparison-with-garb.patch"
        "${_lucjanpath}/${_arch_path}/0003-Bluetooth-Read-codec-capabilities-only-if-supported.patch"
        "${_lucjanpath}/${_arch_path}/0004-Bluetooth-fix-deadlock-for-RFCOMM-sk-state-change.patch"
        "${_lucjanpath}/${_arch_path}/0005-mt76-mt7921-add-support-for-PCIe-ID-0x0608-0x0616.patch"
        "${_lucjanpath}/${_arch_path}/0006-mt76-mt7921-reduce-log-severity-levels-for-informati.patch"
        "${_lucjanpath}/${_arch_path}/0007-Revert-NFSv4.1-query-for-fs_location-attr-on-a-new-f.patch"
        "${_lucjanpath}/${_futex_path}/${_futex_patch}"
        "${_lucjanpath}/${_fixes_path}/0001-net-sched-allow-configuring-cake-qdisc-as-default.patch"
        "${_lucjanpath}/${_fixes_path}/0002-infiniband-Fix-__read_overflow2-error-with-O3-inlini.patch"
        "${_lucjanpath}/${_fixes_path}/0003-pci-Enable-overrides-for-missing-ACS-capabilities.patch"
        "${_lucjanpath}/${_fixes_path}/0004-scsi-sd-Optimal-I-O-size-should-be-a-multiple-of-rep.patch"
        "${_lucjanpath}/${_fixes_path}/0005-iomap-avoid-deadlock-if-memory-reclaim-is-triggered-.patch"
        "${_lucjanpath}/${_fixes_path}/0006-tty-Allow-setting-the-number-of-available-virtual-TT.patch"
        "${_lucjanpath}/${_fixes_path}/0007-i2c-busses-Add-SMBus-capability-to-work-with-OpenRGB.patch"
        "${_lucjanpath}/${_fixes_path}/0008-fm-5.16-port-mm-kswapd-patches.patch"
        "${_lucjanpath}/${_fixes_path}/0009-Disable-stack-conservation-for-GCC.patch"
        "${_lucjanpath}/${_fixes_path}/0010-x86-csum-rewrite-csum_partial.patch"
        "${_lucjanpath}/${_fixes_path}/0011-x86-csum-Fix-compilation-error-for-UM.patch"
        "${_lucjanpath}/${_fixes_path}/0012-x86-csum-Fix-initial-seed-for-odd-buffers.patch"
        "${_lucjanpath}/${_fixes_path}/0013-xfs-check-sb_meta_uuid-for-dabuf-buffer-recovery.patch"
        "${_lucjanpath}/${_fixes_path}/0014-openrgb-Deduplicate-piix4-setup-for-HUDSON2-KERNCZ-S.patch"
        "${_lucjanpath}/${_fixes_path}/0015-iomap-Address-soft-lockup-in-iomap_finish_ioend.patch"
        "${_lucjanpath}/${_fixes_path}/0016-kernel-cpu.c-fix-init_cpu_online.patch"
        "${_lucjanpath}/${_fixes_path}/0017-ACPICA-Macros-Remove-ACPI_PHYSADDR_TO_PTR.patch"
        "${_lucjanpath}/${_fixes_path}/0018-ACPICA-Use-uintptr_t-and-offsetof-in-Linux-kernel-bu.patch"
        "${_lucjanpath}/${_fixes_path}/0019-ACPICA-Use-original-data_table_region-pointer-for-ac.patch"
        "${_lucjanpath}/${_fixes_path}/0020-ACPICA-Use-original-pointer-for-virtual-origin-table.patch"
        "${_lucjanpath}/${_fixes_path}/0021-ACPICA-Avoid-subobject-buffer-overflow-when-validati.patch"
        "${_lucjanpath}/${_fixes_path}/0022-drm-amd-amdgpu-amdgpu_cs-fix-refcount-leak-of-a-dma_.patch"
        "${_lucjanpath}/${_fixes_path}/0023-drm-amd-display-Fix-memory-leak.patch"
        "${_lucjanpath}/${_fixes_path}/0024-PCI-Mark-all-AMD-Navi10-and-Navi14-GPU-ATS-as-broken.patch"
        "${_lucjanpath}/${_v4l2loop_path}/0001-v4l2loopback-${_major}-merge-v0.12.5.patch"
        "${_lucjanpath}/${_v4l2loop_path}/0002-v4l2loopback-${_major}-update-to-latest-git-HEAD.patch"
        "${_lucjanpath}/${_lqx_path}/0001-zen-Allow-MSR-writes-by-default.patch"
        "${_lucjanpath}/${_lqx_path}/0002-PCI-Add-Intel-remapped-NVMe-device-support.patch"
        "${_lucjanpath}/${_lqx_path}/0003-Input-evdev-use-call_rcu-when-detaching-client.patch"
        "${_lucjanpath}/${_clr_path}/0007-port-print-fsync-count-for-bootchart.patch"
        "${_lucjanpath}/${_clr_path}/0012-ipv4-tcp-allow-the-memory-tuning-for-tcp-to-go-a-lit.patch"
        "${_lucjanpath}/${_clr_path}/0013-init-wait-for-partition-and-retry-scan.patch"
        "${_lucjanpath}/${_clr_path}/0016-migrate-some-systemd-defaults-to-the-kernel-defaults.patch"
        "${_lucjanpath}/${_clr_path}/0017-xattr-allow-setting-user.-attributes-on-symlinks-by-.patch"
        "${_lucjanpath}/${_clr_path}/0022-print-CPU-that-faults.patch"
        "${_lucjanpath}/${_f2fs_path}/0001-f2fs-compress-reduce-one-page-array-alloc-and-free-w.patch"
        "${_lucjanpath}/${_f2fs_path}/0002-f2fs-rework-write-preallocations.patch"
        "${_lucjanpath}/${_f2fs_path}/0003-f2fs-reduce-indentation-in-f2fs_file_write_iter.patch"
        "${_lucjanpath}/${_f2fs_path}/0004-f2fs-do-not-expose-unwritten-blocks-to-user-by-DIO.patch"
        "${_lucjanpath}/${_f2fs_path}/0005-f2fs-fix-the-f2fs_file_write_iter-tracepoint.patch"
        "${_lucjanpath}/${_f2fs_path}/0006-f2fs-implement-iomap-operations.patch"
        "${_lucjanpath}/${_f2fs_path}/0007-f2fs-use-iomap-for-direct-I-O.patch"
        "${_lucjanpath}/${_f2fs_path}/0008-f2fs-show-more-DIO-information-in-tracepoint.patch"
        "${_lucjanpath}/${_f2fs_path}/0009-f2fs-support-POSIX_FADV_DONTNEED-drop-compressed-pag.patch"
        "${_lucjanpath}/${_f2fs_path}/0010-f2fs-avoid-duplicate-call-of-mark_inode_dirty.patch"
        "${_lucjanpath}/${_f2fs_path}/0011-f2fs-add-gc_urgent_high_remaining-sysfs-node.patch"
        "${_lucjanpath}/${_f2fs_path}/0012-f2fs-avoid-down_write-on-nat_tree_lock-during-checkp.patch"
        "${_lucjanpath}/${_f2fs_path}/0013-f2fs-do-not-bother-checkpoint-by-f2fs_get_node_info.patch"
        "${_lucjanpath}/${_f2fs_path}/0014-f2fs-clean-up-__find_inline_xattr-with-__find_xattr.patch"
        "${_lucjanpath}/${_f2fs_path}/0015-f2fs-support-fault-injection-to-f2fs_trylock_op.patch"
        "${_lucjanpath}/${_f2fs_path}/0016-f2fs-don-t-drop-compressed-page-cache-in-.-invalidat.patch"
        "${_lucjanpath}/${_f2fs_path}/0017-f2fs-Simplify-bool-conversion.patch"
        "${_lucjanpath}/${_f2fs_path}/0018-f2fs-remove-redunant-invalidate-compress-pages.patch"
        "${_lucjanpath}/${_f2fs_path}/0019-f2fs-move-f2fs-to-use-reader-unfair-rwsems.patch"
        "${_lucjanpath}/${_f2fs_path}/0020-f2fs-do-not-allow-partial-truncation-on-pinned-file.patch"
        "${_lucjanpath}/${_f2fs_path}/0021-fs-f2fs-data.c-fix-mess.patch"
        "${_lucjanpath}/${_f2fs_path}/0022-fix-mess-2.patch"
        "${_lucjanpath}/android-patches/0001-android-export-symbold-and-enable-building-ashmem-an.patch"
        # TODO: This patch was moved at some point. Consider keeping the ll patches we use in our own repo.
        "${_lucjanpath}/ll-patches/0005-mm-set-8-megabytes-for-address_space-level-file-read.patch"

        # https://lore.kernel.org/amd-gfx/20210105220359.1392555-1-joshua@froggi.es/
        "0000-drm-amdgpu-dont-limit-gtt-size-on-apus.patch::${_amdgfx_path}/20210105220359.1392555-1-${_joshie_s}/raw"

        # https://git.kernel.dk/cgit/linux-block/log/?h=for-5.17/drivers-2022-01-11
        #"0000-loop-dont-hold-lo_mutex-during-__loop_clr_fd.patch::${_dk_floppy_path}?id=6050fa4c84cc93ae509f5105f585a429dffc5633"

        # https://git.kernel.org/pub/scm/linux/kernel/git/gregkh/usb.git/log/?h=f2b42379c57682d4b127283da109fa1a3317966a
        "0000-usb-hub-avoid-warm-port-reset-during-USB3-disconnect.patch::${_usb_path}?id=f59f93cd1d720809466c7fd5aa16a236156c672b"

        # lucjan hasn't been keeping the zen patches updated
        "1001-ZEN-Add-VHBA-driver.patch::${_zen_gh}/c5a351434d9c28a38ca821bd4908046b6cf51954.patch"
        "1002-ZEN-intel-pstate-Implement-enable-parameter.patch::${_zen_gh}/50b43196a404f4bf21fd1347c7800db5329ddbe5.patch"

        # https://www.phoronix.com/scan.php?page=news_item&px=Linux-5.17-USB
        # https://git.kernel.org/pub/scm/linux/kernel/git/gregkh/usb.git/log/?h=f2b42379c57682d4b127283da109fa1a3317966a
        "2001-usb-Add-Xen-pvUSB-protocol-description.patch::${_usb_path}?id=bae9401dff62d1ac46504a343db8a69e5ac390f6"
        "2002-usb-Introduce-Xen-pvUSB-frontend-xen-hcd.patch::${_usb_path}?id=494ed3997d752810b67cb75d4721b59996cfec38"
        "2003-xen-add-Xen-pvUSB-maintainer.patch::${_usb_path}?id=a92548f90fa6280ca57a8aea1f50d18f2f48cbb3"
        "2004-usb-host-xen-hcd-add-missing-unlock-in-error-path.patch::${_usb_path}?id=a1f79504ceb3ffcd2b777e5ac84c97a0948c2dbd"
        "2005-MAINTAINERS-remove-typo-from-XEN-PVUSB-DRIVER-sectio.patch::${_usb_path}?id=d538ea945532d0d3bd04192543b285e6979d9e8f"

        # le9 + mgLRU stuff
        # pretty confident these git repos aren't going anywhere
        #"${_hakavlad_gh}/le9-patch/f64c95f700c05ecbd8cde7e008ebfd404cb8832a/le9ec_patches/le9ec-5.15.patch"
        "${_lucjanpath}/${_lru_le9_path}/0001-mm-x86-arm64-add-arch_has_hw_pte_young.patch"
        "${_lucjanpath}/${_lru_le9_path}/0002-mm-x86-add-CONFIG_ARCH_HAS_NONLEAF_PMD_YOUNG.patch"
        "${_lucjanpath}/${_lru_le9_path}/0003-mm-vmscan.c-refactor-shrink_node.patch"
        "${_lucjanpath}/${_lru_le9_path}/0004-mm-multigenerational-lru-groundwork.patch"
        "${_lucjanpath}/${_lru_le9_path}/0005-mm-multigenerational-lru-mm_struct-list.patch"
        "${_lucjanpath}/${_lru_le9_path}/0006-mm-multigenerational-lru-aging.patch"
        "${_lucjanpath}/${_lru_le9_path}/0007-mm-multigenerational-lru-eviction.patch"
        "${_lucjanpath}/${_lru_le9_path}/0008-mm-multigenerational-lru-user-interface.patch"
        "${_lucjanpath}/${_lru_le9_path}/0009-mm-multigenerational-lru-Kconfig.patch"
        "${_lucjanpath}/${_lru_le9_path}/0010-mm-vmscan-add-sysctl-knobs-for-protecting-the-workin.patch"
        "${_hakavlad_gh}/disable-i915-gem-shrinker/4e6da2a9b0602d3f80b418026d0a8bf188fc0de6/disable-drm-i915-gem-shrinker-5.10.patch"

        # https://clbin.com/VCiYJ
        "0001-pcie-reset-kludge.patch"

        # The rest of the patches came from random git repositories. In my experience, random git repositories tend to
        # vanish, so instead of pulling the files from the repositories, they will be included in this one.

        # https://github.com/Frogging-Family/linux-tkg/tree/master/linux-tkg-patches/5.16
        "0001-mm-Support-soft-dirty-flag-reset-for-VA-range.patch"
        "0002-mm-Support-soft-dirty-flag-read-with-reset.patch"

        # https://github.com/kevall474/kernel-patches/tree/main/5.13/misc-patches
        "vm.max_map_count.patch"

        # the main kernel config files
        'config')

## For consideration:
# https://www.phoronix.com/scan.php?page=news_item&px=AMD-PAN-Linux-RFC
# https://www.phoronix.com/scan.php?page=news_item&px=AMD-Linux-5.18-Sched-Zen-LLC
# https://lore.kernel.org/lkml/20220206022023.376142-1-andrew.smirnov@gmail.com/
# https://www.phoronix.com/scan.php?page=news_item&px=Speculative-NUMA-Fault
# https://www.phoronix.com/scan.php?page=news_item&px=AMD-x2AVIC-Linux-KVM-SVM
# https://lore.kernel.org/lkml/20220202041112.273017-1-suravee.suthikulpanit@amd.com/
# https://lore.kernel.org/lkml/20220211000851.185799-1-suravee.suthikulpanit@amd.com/
# https://lore.kernel.org/linux-wireless/20220226045047.643695-1-mikezackles@gmail.com/
# https://wiki.archlinux.org/title/fbsplash
# https://bugzilla.kernel.org/show_bug.cgi?id=202055
# https://lwn.net/Articles/711248/
# https://github.com/zen-kernel/zen-kernel/commit/d7406fe7e75e1fe31e6b16474fb76f99e2c5926c
# zen3 noflr patch
# sm2262 noflr patch

sha512sums=('01639c4cec36aa9718cdd2c720289bb26d2da6a208bb0d0466de0a82cabec3254fbae528740404cdcba33c3f1801c098c53521f2cb58f93a01b4c3daa658f78e'
            'SKIP'
            'SKIP'
            '5cb79731f957372cbd3ddaf93ac1cbc6eca4a526225f5bbe9c5eed11529fbefa66934ac5002410505df84281144da15e39326a8df886fe45da937304ed0b6fcf'
            '860c3d6f0c1b4528e11ce3e99cb0c3acf67f8f657f1471774bd14d75bdc92a72eb33d60fc3b7fd7465b2716733a5c7ad9d07107f96f2a568505573618583d5dd'
            'ab229799fe12a9a9b1f52ea8714abaa66085a3173f04e2d5e533b0920ba8b72e41c37ab7332db8b15b1810b9b14baf84777128de9d3495f7b438cdb5805f1a25'
            '8b4d881cde779b016ea01f959130c2ad0f511aa09e11b7c725acdc06baf536d3ca5ff8284dfb8fd0321f04a338a6e144babfd679fed95717e47e93a787b3415a'
            'e7c5d1bebafe300a67a3839094841c47b645653a14eb33dc9d63c29aaaed57d02ce723bd90a5bb48050f14d96b129d85f89fe74a7a13b30f99d4a0d98a1dfb55'
            '56f7f517da01646ee9ef6a5842d2ec59fa77d8e280e34ea6aa9bba27bd5c8863b7659e1e792107be517e3ac77466ed57263bb0d5a9618cd7a2ad71b9639264d7'
            'fe34ea8073cf29a53048be729f2ada6af38656d015061178452c6d60ab0f97f81e8d282193ba39dbba198263b3d2ff7f39ae33caded7b681600ae3391aa18a21'
            'dbdb3daf6f309e79890bde2eb9b72e3f3fa9e55be395b2bfb6385179d48793cdd440fd757481281b081a10f1e28b172de0076a518831842b9ab444e4733df071'
            'f3336e323d3ed186bfbc7ca01eec9967d1ffd71ae254707282caf8d7af66c5c11f39498da642a0768245e79918a857d76d807c7c99a32e9145e8524c58415fe9'
            '30b87aa3670120e1eff79cb1dbae8936493e2410500d52ff2597ef549e89b638155619e7e28884a922df1d61fc53423743649a735564a8f390982ff34668cfca'
            'e07d6ea798eee25c22b347312728fed2747778b7b9cd99759f5a0cba6594954ab360efee9db307fc43d4d2b34f5370e744a1711968c27ebe96166e66c4728e26'
            '70409e09f0d2317e0c6c4344c2dfea9b7b46df15ce0bc269e3ddabecb8da1a5fae7d2573a3878422a9b9400bd357049dd9dd6824e7b4b622bccdb41676c95527'
            'c256d4ffc6391939b3d34399b58749deb70429d1550a6d7bb2681b5edf2efa7a9bf3fc11c7b6d927f1bb42b5b6203e54b332a3a7788d52d606325ba10b2d3d4e'
            '3b161667dbdae8e56393107522f765823dbec6dcf5005b9c41fbfea0f319623c0313d28f3502c52d5b29a8b4991c5d7ecb58d730cc77cbc724423067ef4dabdb'
            '3488f300c782aec873ad9bb1f37b8f6ed5a17b9bfc7d48f736ed6acd52282a72371d70f81cfe53243f97bdebd5cba6d8c9633842c00fc875eda7ea23548bb91f'
            '4acad0b24566c1cb9c88588e58936e7dccc99b8a6ecfc5550be0aed994d08dfd3f47dff0d54f163d67ce33d37ddf56ae7be079178ecf42b0fa4e0ebb630ccd0b'
            '0201f782c08ddff2e66157ef49b8ec42bf60aacb748a2f7382f5735a9428588140a88e59f3eaca38ddb54597876e7a3eae40ab1599686f2e7012ad28f7b67d2f'
            '4aeb0db5ef302e6d46716986352fcf5e6378e6dd8c0e4505767221dba7458a7cfc50224ca7351d8c201260bf68eec56fb59fd05f69a6e3c9b1a8a75897832d16'
            '4167255006c434a664d8808c6e562ab29812eb3c511f367dc064cf15c1a52ffff0ab1f961840fb13cc8fcb836a954ab2e2fea6ab784d8235d5227523c894a982'
            'ee14ac8f451cc2d04c7156a7e3bef300782a0fc6812183709f33b9eea54e232584d21e5c1515e23bbd239d58140d1fb88184166586e4577270f134a24e5e96a4'
            '174c8be8aee58cf40989b31955dae5588f89aa15b7b6c11c0a1f3eadf7f1994745c6acf1d8855ca2e2b076ce944e2a6036f6c6e96beedc4da0a5fd4c344942db'
            '8fe0b2e45b68aa18481c315774a17f09398e62187f23c8791170a6cb50f138f1327b54e7571b8bb51855b09ad112553eef309ad411238b2fb7f93feb4f57ca52'
            '243b4123c01595b6807f10cea7de079f7dbe4ecc679b3dd40ee97b6fada12ec28d1bee45f7df6acd089eda94c1718b83cb564f9e2d02bc6531771b1586592a45'
            '171446347daebe7273ca6c87ae27ad04ffb5ac63e61f695f486701f5a669d558a865a3ed2ebb253ac07bf46a85e92f4d7e389316daf078d8a232acdea5180b4d'
            '9a1c53ffdb642816510932e9d0ceb65efaff0b8cc9799bfb146ce39e6a28bfd22a456844c618499317bf22e66610a8f4c97658f5bd866154134249c6000a4532'
            '6031000a3c8624ed7657d7dd987b571f8923fe54b22cbbd3c98f5d49715393e4b5bd803ece99a389f1c5d2347ab6e5bac4d70e6607e0f5224e87b53c33b2c2a6'
            '7c901b44e3c7988e1ffd0d4cef74c327c6f8d1a699ee0103bf9d7ba9fdc784a8f34fc2136f8b42daf926ebf4bb99e71ec6967e835f917805710b74829f7412b0'
            '7924b7b40ef6a9df62abb535c124638c0abe3450476934bf24b6ae6030cad7ad31a4f58862cf30c7b93797762aa3605a3389015046325ed9e656e0420772d012'
            'ee611037a251322e121cef0ebf00ea1743a5956d40115b966d5fd0e8f0d0940f343be4cc3ecebe01086c9d606d62b1d6a06e02907d88abc1bae2a786b9bbb114'
            '5cd23bd27ea8cb6b9600c83cb8a5ba7f63e3e3a44719cac81047bc673af3bb6a5d3a83f379c531ea4ab6160465f1c9b4816526fc99a0698416957fea4a81b544'
            'd995c0233c6f6e1f873a0d4196b2441bd8c7521e6f39109570bdb39d8e88430afad9c258451790e56e1712178db80edc40f94a8db4345aa205b7ce91940af1de'
            '46958b492442cc57ae962de9059f5b34a3f97dbd14d1fe9fcf15a7f566c1e02d46be2215b4771a1e4962df9db341a3dff0fbd5dd46a2121d8bde0495373adcad'
            '3d812b15238bc692590a4fa19a583c9a7b81f13605bd34474ddb15bbce44b6efd9c3008ea6909e9ba55be7b5306c523230a4595fb734a640ea75db1bd8799580'
            '7ae8ab98b103f9f73d46fc59191eb915a0d71c3e8e422c9309ad98597a1a566cfe2bcca76c886dda7adfcb1d05e56a60af5b260bb5c4ed4b9d9b4bbbc371a23b'
            '981dcbb9700de3911ba4064f75ae823045d11faaa750f959dfd7a92acaab8369fe73cb098d07994a24cfd64d0b1c07c179f16cf42008d6072654e8f295fd206c'
            '4b5530b53a511ae4b5f5d608a6c6ef566a4778d12e8d4e8cf82e2def09b758ac4c20d83bcbd3a3bea15906b08ce29268e0c80800d8a1230b690b6e09f7e005c0'
            '72983cb14a47a759d43f359c7813b8096365940faa2be8dde1544f6f75b8b0991d315fed30a5cce4738de357bc66dccd240b9d8157d80cae943cb9dcf34e8ace'
            '37ca85b7ba507bdf92758013351719c8557c2dd0873dc716b7f10956838bfcf079aefe935abd22e9d08c2fee814c3581d103508f18e62baf948761fbb0bf74fb'
            'c4e65d66112426d119f0ea81fc9fbd368ee94d8eaa765828c090ba93612ea953f61ba7e241ac4328dc61ac79168b4ee09d16a8bb8098edede3d20e1b6b62d553'
            'c9d30a4c8a82c13387d2ee0932ac374561f064802f37666d9adc50731524767eb803fd3df8982be53b851179ae1ad42f2890db675859efc460ef8abaac69cbbe'
            '809898f4664f60f8d201b4257ecdec12ab1f3af3c0d96e727f8c0afc98b82a99fa62b26c534b8d8eaf66c59a4dfb6546b20404a251ec58697db011a9790c64a4'
            '71d0ac0ecb917800a0d2ecb5bfa7c79c3e0b7fca7b6399aa668296002031d9513cc6f15a672797e5e15febfcd54a6bf22ed9d14c6a54d284bc31903edcb74dc6'
            'e3d3fde2e52f527401a188366e53826999e508b01955a55f5e2c56b9b2d0d821f5ee8df2fabd95798570faf775e4812d93e22e1d7625fd507fad2e30283b21b1'
            '0ad1e48d37a6f0cd88757a897fe6464763a3dbecb84f348051f5d4cd8554212a92af8ba5bfe1c92c543201b04bfd7bfca551cb2edb7c0f1bc6e72af9260c3fc6'
            'ec037a05a9e50e5772d7892a9a8755e4abb813414d5e36050ef414850c2d82dc6d879b0bb832fec3b4846f9022af7e69e1c7b68c96fdc1dc51e2b5cd95c79179'
            'd26af1ea0010e38ba761fd29594f1f21a0e536fef4ff19b14e4b6e83c12bda7817890b2242d2d4cb3c8e3e4552dc34ede5e6edf60ef17cd67532aa123c423b3a'
            'e7b71b66fcd7a9300ce7129924498aa6e68708421e50ed9302b74f4f1f87b1b34686dc6f085350dac4b3499d97ca5a66b5418e3cfebd8beeafc531d679dfb52e'
            'f72d15389ba47ebae86c07a5a3c726c6d73a6582b347e3267c5aaf0ef3df657de42815a61e05fb0b9bfc367dd259b2c5b75c6b03d34ab992399e0a8ec12b9d6d'
            '49520decff482e748f74e84313f4cd0d280c49de66dac91fe1de239e980e164072004944e5c19273b045be0680a4866ea5b174dd7cf6783aec2f62d9d42e09b2'
            'fb10e80c785a36154f06e7648208ed015057cab1e73a7139cf4b738ab9f23763de92e270c5c8565c28979873b444b7bebd67828a83d4c58cbf0f71f26c85fde6'
            'f9343fc9f367d66dfe70198a84993cc2b649ea4a9ad012e15a9c3e9b35266d4d21bea643eed7761a5485361c77f380e186f5ed9295232b95b192f20a8b91417b'
            '5ff60eaac3eb184f2a3a1fe6cfe7cbbd79d30881ccead3ee2985301ae34af85496f5b2a7cc842840e8b73924f30f81e47f9820cdf1bcaaea743e7cf93e0cdb5c'
            '9f8c9307b90e3315d3619fdd625e16fef178c9b20543f9648b532a100e421d36a66ad2973b5ac74e0a02910dd8b2be61592ad661cb6caff318cd540a94ddd0ec'
            '86b301ae01036972051cd74c96448f16349dcb5c43619748124d70428ac8c68f6c1f187f02e2bf6e77c260cf435aee4eb0cd08e40f599b4230066cb51839a6c0'
            '57e4d55fb7e5801bb8cf17b8766d16b4c09334ca684e7f314cbe42b2f297309b0c5b34f0a4e080998353f0f8b9db45b0eb37ee9a29b71fdad70a48b2d201bf9e'
            '9f948585484592cd9a996261a030472ca43ce713470b70e270e58deba074cdcee33f4e57e74da9dde5a8f404ce1abc0b9764d585cffab37774bd9f6af90b7724'
            'dd5d99ca6169d33fde924f7631998a276044f6e5970f6b1983ac627235cd0f489cd037bbe58df8c2333b144224eb17d421321a346b32b39217105ea9420ae7e8'
            '101aaabc58112c499f5a2ba9558c61f42d03824cfcee4b421e8e364d87c96ee026ae19c8df45c7ffca104561eca908410f76b7b72e7dca87971754b1ddf84db6'
            '7d53327433ce968a463be342301539fbd3eeb4b79696dc7efd2a2ca08b5ab73f9464e7699040bc6822e1bb3948c3dbb14537cd30902ae021f6e085bc44ca50a5'
            '5a83984fb7b4a242f6385168f1da60b47f5a4eb0f31e41b1e990a1a7fa0c99b7abbc76c809d945f09ad3e7afe00bd1216a03155dc530d7aa016e85a01681a9b3'
            'b05dfc6f13f5b9c1b834659f8bb3b2427bd7f2a26cd98ce2e12b00a9c185cbfc568085b6713ef8f213504cdf80b5c73ef400a5a752a2e3de220afbb84a4d3157'
            '93ace663b59c027f926bf3161a2f2b6342ac60ec78448887856f2e31b5f212f65521efccd7f5c0ccd20af5dce74dbff1a3bc366b990bab7f6cc0bb13e834ae0f'
            '37b2a2a061c80a5ccf0b5cd3a3c9c6111265a2fe9ce77ef46ec22ecffa73cfa79643b5b3d986d3f0157557320a5568a4b29e42e96da240ceb7c2b8e4257c130b'
            'e9158b583b291e15918d233b3e0947b4c98aecd464e50953cc8c37c2fcfaa77c8d1ca196b95e3db6387d8dc39e5dfb92ff85c9d58720ba79a205d41f066219ef'
            '057165316ad760f41ed68aafab7638586a499b04d50f36e5dc19f3367d6700f4dfb378f798817d42e8112183190cc5e1f86d0eb76fb2c7f93ec351db97e4b5c4'
            '96fb224ce30264fc89ebd0575b41c2a832ca7b1282790690f2965bb559804386c06b17891d4bd2d8a21956871638165fb27d55d615a53601f555b0e19f7b4740'
            'b9df26d3b6be1bb2da82c12a58ad3c400ffa59b97aafa6f0898c563b9e4418d26acca451c1e0ccc8c4ef67caf3ca5eac998bcc06e4940179d8808d4c147227cd'
            'ff0e900a6b44355064d12ecdeabc0acf7609d86f08cdc6bdf6bf32ff707892ef04e65909d426914a3407360e5595c94b53a064e1404b425a520a7fdb300ac06a'
            'c99b280a2546b95f254850cbc306e0f0345068fc03df19dbc23258dacd91b7b01fc84167b0030e52ea9dc650ff541dc27591514f0828bb923e92b0c7c5f40674'
            '84c236f92ffc9d14b0f8462ca606080f3aa4d9fe5f103a9c1cdc7990a9b14c788bd18664b51d8b4839b2c18e6a323758593b358a6985a6a96b136dbc60b23031'
            '683d582b24542bb062d22687fc9113007be6e9c4d431ab0e2e999ce44bc9b1cc317957719056624654e8c72416c6abe209d3b9755514e8c99931a125dc666912'
            'a949b964953646410c55bded1fa07e4a57cee69e1de23448c34b7950589c2cec25cea948e518d5ed3d3755b65412620b642bbf0e1f8fa05dc1c66aaecd15988b'
            '9a40c4b7ff789253e0a830ebfd688da722804a922bca507c7d39edafb00343ec7bd7ecaab8980fdc4969a6c4ac4cd91d3dbf7ea6118fdf142e7720e2fc6247c9'
            '675d6dfc5d324ca09d99d8db7862971ca22a7d7fec3b8f4f3d55dc525843449ed1a095d45bf39c165f669f23029841258d448d235606354f6a606339958418bc'
            '16df1c1730726ec161be304a843af72148177ec9becd63b03cfdb301662a86d4fa7a78957efbc52a098761617992bde16fccead5d0dacc5318735020bffb45c7'
            'a279af97b27d6da76799093aa99962fc924b007fe1c9df7bd2496ea41d6ec1299c4cf5e1c61d368ef6df84054da0201fde024e44a12ffc5534bf6b82026b7144'
            'b65389b44817cb710a9f787a76dd5fa0c99f0db4a05b7b582ebe1e85cd02ea05f7503dfc4659ad39251a10c9ff5709c12466c52b227de1c07f87b35a14fe4ad7'
            '0661ec0d6f96af7cfb8b517de8ef6c2c51bf1b7056c0c59ec2b992fc5c71a991b707e036d1a749383b2972d1c1d52b3e551b23fc33534906ed6865c40d950e77'
            '59eef01a26b32766ff8cb03873e9c7dee4442b39d67965a7e4f04041d7189b1aba5980a2f184ceb40bec2cb48a9116eb5e4c17f0d48667623480ddf0cf96f24f'
            'f69aeedd4cb87244e71cd71cecb3eab78a9f266d2d42871ec3d43d43640cd40ce0f859c2ac14b0506d352cc9489306517e4aae41f8d913d37de544563bf3e59f'
            '9b8aa7d13b14b969267fec514e558c91ca98bba5de1001c8319b0e762b30ba24c154aa96973a97e3034855d6d6ff4aa5ec4f7be423a4df4b2251e4e054a37fce'
            'be38f53391bc04922b6712d65c2eb679b2f9683a46b473d6ee953bb559a3aa85f991961534995966e0fe187bdbaa69be12f4d39032d82d3dd9c8922ea379fc38'
            '2eaf4c0450330116cc8e3637809c512988c4a58aca09eab835bc3fdd5e05592755e84dc3ca9c67259014c899e041825982e14032166f666abe8acea4de1280f1'
            '28483022c7e5608026e6e0512421bdd7704180ffb28bc803bf0680064493f09c125d81a9584892c1c2c57b2dea88609af8bfed1ba3b4782d379599216321f305'
            '097353f2a924d570f52664941b7db79c482ba46ead3187536c6d4e5c404b1ae68315a9513ca165ed8d2945b4d643d43d67cbc55baab341e1290541f5142c1d4a'
            '7d03430fd617ab3ad3e1dac77ea7d7ea50f6e691c09f3bc634335c67622da3ab283f9b2e345504d41e762033861932653b759399832c98a9d6ae769fc71cb667'
            '744a27917c3299ba7faa84eb77ffd10c763a23304fa9a26d1689cce7c89c98725e885e3ca03e998c57c3a1b6cb093e5dd48abd57597bb86b2a030f0d830a1580'
            '5156083c4e764bf47d46c6bb5fec958a22f88c4842c4549d6992e663ff0c7caf9af616c0949f0905d93c768005ebdfc39b6a129ef2a50e5f9dc600a34ab9ec76'
            '310654b8bb11aa1af48d6fae21d0c6bcfe9f06c27828274c5749d0ab0d759e77441e8b5323b8c6665b23161c9d35c4a9743948cc1b474deb3b1d2c98752cbd97'
            '389f51ba3943815f7cce13f6029cb5b196edbc9c27245f7d96ccb3231b61f76522d50e9010e9ead73d968266edace559c8f783738ee0e9ab8290fb324a230bc6'
            '9193db6debe578bd69c338b24bcfa26e0ae719a78c5f63b442d02d7790ee59397eeb85fe683ed96ad053ab784c9860295c0d149405cb826031b6eb129ca45a0a'
            'f2748495022b16ef93835b34bba1086b415bf90833836b150e0cae2652f6101c337895699476eb98a9ba5cb2eca9dfe9c9bcc2a23cdbc31bc402ab498fac48d4'
            'c692ba944f7b1212e28165653f49785abd9ec346afa29cd19e5d0a4afba0a17b8cf57cefa53bfe3c502d6dec0d67422e988e7c8ad446df0f0aac0a5136fe55d0')

export KBUILD_BUILD_HOST=archlinux
export KBUILD_BUILD_USER=$pkgbase
export KBUILD_BUILD_TIMESTAMP="$(date -Ru${SOURCE_DATE_EPOCH:+d @$SOURCE_DATE_EPOCH})"

_aufs_patches=(
	######################
	## Required patches ##
	######################

	"aufs5-kbuild.patch"
	"aufs5-base.patch"
	"aufs5-mmap.patch"
	"aufs5-standalone.patch"

	######################
	## Optional patches ##
	######################

	## Add support for nested loopback mounts in branch-fs
	#"aufs5-loopback.patch"

	## Make /proc/mounts show all mountpoints
	## Does not exist in the current tree?
	#"proc_mounts.patch"

	## Prevents assignment of 0 as inode number
	"vfs-ino.patch"

	## Keeps tmpfs inode number low
	#"tmpfs-idr.patch"

	## required for LOCKDEP
	#"lockdep-debug.patch"
)

_aug_colorize() {
	# prefer terminal safe colored and bold text when tput is supported
	if tput setaf 0 &>/dev/null; then
		_MAGENTA="${BOLD}$(tput setaf 5)"
		_CYAN="${BOLD}$(tput setaf 6)"
	else
		_MAGENTA="${BOLD}\e[35m"
		_CYAN="${BOLD}\e[36m"
	fi
}

_msg3() {
	(( QUIET )) && return
	local mesg=$1; shift
	printf "${_MAGENTA}   +-${ALL_OFF}${BOLD} ${mesg}${ALL_OFF}\n" "$@"
}

prepare() {
	_aug_colorize

	cd $_srcname

	### Setting version
		msg2 "Setting version..."
		sed -e "/^EXTRAVERSION =/s/=.*/=/" -i Makefile
		scripts/setlocalversion --save-scmversion
		echo "-$pkgrel" > localversion.10-pkgrel
		echo "${pkgbase#linux}" > localversion.20-pkgname

	### AUFS
		msg2 "Copying AUFS build files and applying AUFS patches..."
		local aufs_srcdir="${srcdir}/${_aufs_repo_name}"
		local kern_srcdir="${srcdir}/${_srcname}"
		pushd "${aufs_srcdir}" > /dev/null
		cp -r {Documentation,fs} "${kern_srcdir}"
		cp include/uapi/linux/aufs_type.h "${kern_srcdir}/include/uapi/linux"
		popd > /dev/null
		local aufs_patch_fname
		for aufs_patch_fname in "${_aufs_patches[@]}"; do
			_msg3 "Applying AUFS patch $aufs_patch_fname..."
			patch -Np1 < "${aufs_srcdir}/${aufs_patch_fname}"
		done

	### Patching sources
		local src
		for src in "${source[@]}"; do
			src="${src%%::*}"
			src="${src##*/}"
			[[ $src = *.patch ]] || continue
		msg2 "Applying patch $src..."
		patch -Np1 < "../$src"
		done

	### Setting config
		msg2 "Setting config..."
		cp ../config .config

	### some initial configuration
		# (we start with the arch config as a base so I can keep track of stuff easier)
		scripts/config --undefine CONFIG_LOCALVERSION_AUTO
		scripts/config --enable CONFIG_LZ4HC_COMPRESS
		# from patches
		scripts/config --enable CONFIG_FUTEX2
		scripts/config --enable CONFIG_VHBA

	### for debugging
	### https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=0aaa8977acbf3996d351f51b3b15295943092f63
		# prink and demesg options
		scripts/config --enable CONFIG_DEBUG_BUGVERBOSE
		scripts/config --enable CONFIG_DYNAMIC_DEBUG
		scripts/config --enable CONFIG_PRINTK_CALLER
		scripts/config --enable CONFIG_PRINTK_TIME
		scripts/config --enable CONFIG_SYMBOLIC_ERRNAME
		# Compile-time checks and compiler options
		scripts/config --enable CONFIG_DEBUG_INFO
		scripts/config --enable CONFIG_DEBUG_SECTION_MISMATCH
		scripts/config --set-val CONFIG_FRAME_WARN 2048
		scripts/config --enable CONFIG_SECTION_MISMATCH_WARN_ONLY
		# Generic Kernel Debugging Instruments
		scripts/config --enable CONFIG_DEBUG_FS
		scripts/config --enable CONFIG_DEBUG_FS_ALLOW_ALL
		scripts/config --enable CONFIG_DEBUG_IRQFLAGS
		if [ -n "$_use_ubsan" ]; then
			scripts/config --enable CONFIG_UBSAN
			scripts/config --enable CONFIG_UBSAN_BOOL
			scripts/config --enable CONFIG_UBSAN_BOUNDS
			scripts/config --enable CONFIG_UBSAN_ENUM
			scripts/config --enable CONFIG_UBSAN_SHIFT
			scripts/config --enable CONFIG_UBSAN_UNREACHABLE
			scripts/config --undefine CONFIG_UBSAN_ALIGNMENT
			scripts/config --undefine CONFIG_UBSAN_DIV_ZERO
			scripts/config --undefine CONFIG_UBSAN_TRAP
		fi
		scripts/config --undefine CONFIG_WARN_ALL_UNSEEDED_RANDOM
		# Memory Debugging
		if [ -n "$_kmem_debug" ]; then
			scripts/config --enable CONFIG_PAGE_EXTENSION
			scripts/config --enable CONFIG_PAGE_OWNER
			scripts/config --enable CONFIG_DEBUG_KMEMLEAK
			scripts/config --enable CONFIG_DEBUG_KMEMLEAK_AUTO_SCAN
			scripts/config --enable CONFIG_DEBUG_OBJECTS
			scripts/config --set-val CONFIG_DEBUG_OBJECTS_ENABLE_DEFAULT 1
			scripts/config --enable CONFIG_DEBUG_OBJECTS_FREE
			scripts/config --enable CONFIG_DEBUG_OBJECTS_PERCPU_COUNTER
			scripts/config --enable CONFIG_DEBUG_OBJECTS_RCU_HEAD
			scripts/config --enable CONFIG_DEBUG_OBJECTS_TIMERS
			scripts/config --enable CONFIG_DEBUG_OBJECTS_WORK
			scripts/config --enable CONFIG_DEBUG_PER_CPU_MAPS
			scripts/config --enable CONFIG_DEBUG_STACK_USAGE
			scripts/config --enable CONFIG_DEBUG_VIRTUAL
			scripts/config --enable CONFIG_DEBUG_VM
			scripts/config --enable CONFIG_DEBUG_VM_PGFLAGS
			scripts/config --enable CONFIG_DEBUG_VM_RB
			scripts/config --enable CONFIG_DEBUG_VM_VMACACHE
			scripts/config --enable CONFIG_GENERIC_PTDUMP
			scripts/config --enable CONFIG_KASAN
			scripts/config --enable CONFIG_KASAN_GENERIC
			scripts/config --enable CONFIG_KASAN_INLINE
			scripts/config --enable CONFIG_KASAN_VMALLOC
			scripts/config --enable CONFIG_PTDUMP_DEBUGFS
			scripts/config --enable CONFIG_SCHED_STACK_END_CHECK
			scripts/config --enable CONFIG_SLUB_DEBUG_ON
			scripts/config --undefine CONFIG_DEBUG_PAGEALLOC
			scripts/config --undefine CONFIG_DEBUG_KMEMLEAK_DEFAULT_OFF
			scripts/config --undefine CONFIG_DEBUG_RODATA_TEST
			scripts/config --undefine CONFIG_DEBUG_WX
			scripts/config --undefine CONFIG_KFENCE
			scripts/config --undefine CONFIG_PAGE_POISONING
			scripts/config --undefine CONFIG_SLUB_STATS
		fi
		# Debug Oops, Lockups and Hangs
		scripts/config --enable CONFIG_DEBUG_ATOMIC_SLEEP
		scripts/config --enable CONFIG_DETECT_HUNG_TASK
		#scripts/config --enable CONFIG_PANIC_ON_OOPS
		scripts/config --set-val CONFIG_PANIC_TIMEOUT 0
		scripts/config --enable CONFIG_SOFTLOCKUP_DETECTOR
		scripts/config --undefine CONFIG_BOOTPARAM_HUNG_TASK_PANIC
		scripts/config --undefine CONFIG_BOOTPARAM_SOFTLOCKUP_PANIC
		# Lock Debugging (spinlocks, mutexes, etc...)
		if [ -n "$_tlock_debug" ]; then
			scripts/config --enable CONFIG_PROVE_LOCKING
			scripts/config --undefine CONFIG_PROVE_RAW_LOCK_NESTING
		fi
		# Debug kernel data structures
		if [ -n "$_kmem_debug" ]; then
			scripts/config --enable CONFIG_BUG_ON_DATA_CORRUPTION
		fi
		# RCU Debugging
		if [ -n "$_tlock_debug" ]; then
			scripts/config --enable CONFIG_PROVE_RCU
			scripts/config --enable CONFIG_PROVE_RCU_LIST
		fi
		# Tracers
		scripts/config --enable CONFIG_BRANCH_PROFILE_NONE=y
		scripts/config --enable CONFIG_DYNAMIC_FTRACE=y
		scripts/config --enable CONFIG_FTRACE=y
		scripts/config --enable CONFIG_FUNCTION_TRACER=y
		# stuff I added
		scripts/config --enable CONFIG_CRASH_DUMP
		scripts/config --enable CONFIG_PROC_VMCORE

	### AUFS
		scripts/config --module CONFIG_AUFS_FS
		scripts/config --undefine CONFIG_AUFS_BRANCH_MAX_127
		scripts/config --undefine CONFIG_AUFS_BRANCH_MAX_511
		scripts/config --undefine CONFIG_AUFS_BRANCH_MAX_1023
		scripts/config --enable CONFIG_AUFS_BRANCH_MAX_32767
		scripts/config --enable CONFIG_AUFS_HNOTIFY
		scripts/config --enable CONFIG_AUFS_EXPORT
		scripts/config --enable CONFIG_AUFS_XATTR
		scripts/config --undefine CONFIG_AUFS_FHSM
		scripts/config --enable CONFIG_AUFS_RDU
		scripts/config --enable CONFIG_AUFS_DIRREN
		scripts/config --enable CONFIG_AUFS_SHWH
		scripts/config --enable CONFIG_AUFS_BR_RAMFS
		scripts/config --enable CONFIG_AUFS_BR_FUSE
		scripts/config --enable CONFIG_AUFS_BR_HFSPLUS
		scripts/config --undefine CONFIG_AUFS_DEBUG

	### CPU optimization
		# I want to be able to slap an HDD with this kernel on it in just about any machine
		# I'm very, very unlikely to encounter any CPUs older than AMD K8
		scripts/config --enable CONFIG_MK8SSE3
		scripts/config --undefine CONFIG_GENERIC_CPU
		# I'd add an -mtune=znver1 if I could

	### NTFS3
		scripts/config --module CONFIG_NTFS3_FS
		scripts/config --disable NTFS3_64BIT_CLUSTER
		scripts/config --enable NTFS3_LZX_XPRESS
		scripts/config --disable NTFS3_FS_POSIX_ACL

	### Android stuff
		scripts/config --enable CONFIG_ASHMEM
		scripts/config --enable CONFIG_ANDROID
		scripts/config --enable CONFIG_ANDROID_BINDER_IPC
		scripts/config --enable CONFIG_ANDROID_BINDERFS
		scripts/config --set-str CONFIG_ANDROID_BINDER_DEVICES "binder,hwbinder,vndbinder"

        ### Switch controller drivers
                scripts/config --module CONFIG_HID_NINTENDO
                scripts/config --enable CONFIG_NINTENDO_FF

	### mgLRU stuff
		scripts/config --enable CONFIG_LRU_GEN
		scripts/config --enable CONFIG_LRU_GEN_ENABLED

	### le9-patch values
		scripts/config --set-val CONFIG_ANON_MIN_KBYTES 0
		scripts/config --set-val CONFIG_CLEAN_LOW_KBYTES 262144
		scripts/config --set-val CONFIG_CLEAN_MIN_KBYTES 0

	## Fill in remaining defaults
		make olddefconfig
		diff -u ../config .config || :

	### Prepared version
		make -s kernelrelease > version
		echo "Prepared $pkgbase version $(<version)"

	### Optionally use running kernel's config
	# code originally by nous; http://aur.archlinux.org/packages.php?ID=40191
	if [ -n "$_use_current" ]; then
		if [[ -s /proc/config.gz ]]; then
			_msg3 "Extracting config from /proc/config.gz..."
			# modprobe configs
			zcat /proc/config.gz > ./.config
		else
			warning "Your kernel was not compiled with IKCONFIG_PROC!"
			warning "You cannot read the current config!"
			warning "Aborting!"
			exit
		fi
	fi

	### Optionally set tickrate to 1000
	if [ -n "$_1k_HZ_ticks" ]; then
		_msg3 "Setting tick rate to 1k..."
			scripts/config --disable CONFIG_HZ_300
			scripts/config --enable CONFIG_HZ_1000
			scripts/config --set-val CONFIG_HZ 1000
	fi

	### Optionally disable NUMA for 64-bit kernels only
		# (x86 kernels do not support NUMA)
		if [ -n "$_NUMAdisable" ]; then
			_msg3 "Disabling NUMA from kernel config..."
			scripts/config --disable CONFIG_NUMA
		fi

	### Optionally load needed modules for the make localmodconfig
		# See https://aur.archlinux.org/packages/modprobed-db
		if [ -n "$_localmodcfg" ]; then
			if [ -f $HOME/.config/modprobed.db ]; then
			_msg3 "Running Steven Rostedt's make localmodconfig now"
			make LSMOD=$HOME/.config/modprobed.db localmodconfig
		else
			error "No modprobed.db data found"
			exit
			fi
		fi


	### Running make nconfig
	[[ -z "$_makenconfig" ]] || make nconfig

	### Running make menuconfig
	[[ -z "$_makemenuconfig" ]] || make menuconfig

	### Running make xconfig
	[[ -z "$_makexconfig" ]] || make xconfig

	### Running make gconfig
	[[ -z "$_makegconfig" ]] || make gconfig

	### Save configuration for later reuse
	cat .config > "${startdir}/config.last"
}

build() {
	cd $_srcname

	make all
	make htmldocs
}

_package() {
	pkgdesc="The $pkgdesc kernel and modules"
	depends=('coreutils' 'kmod' 'initramfs')
	optdepends=('crda: to set the correct wireless channels of your country'
	            'linux-firmware: firmware images needed for some devices'
	            'modprobed-db: Keeps track of EVERY kernel module that has ever been probed - useful for those of us who make localmodconfig')
	provides=(VHBA-MODULE VIRTUALBOX-GUEST-MODULES WIREGUARD-MODULE)

	cd $_srcname
	local kernver="$(<version)"
	local modulesdir="$pkgdir/usr/lib/modules/$kernver"

	msg2 "Installing boot image..."
	# systemd expects to find the kernel here to allow hibernation
	# https://github.com/systemd/systemd/commit/edda44605f06a41fb86b7ab8128dcf99161d2344
	install -Dm644 "$(make -s image_name)" "$modulesdir/vmlinuz"

	# Used by mkinitcpio to name the kernel
	echo "$pkgbase" | install -Dm644 /dev/stdin "$modulesdir/pkgbase"

	msg2 "Installing modules..."
	make INSTALL_MOD_PATH="$pkgdir/usr" INSTALL_MOD_STRIP=1 modules_install

	# remove build and source links
	rm "$modulesdir"/{source,build}
}

_package-headers() {
	_aug_colorize

	pkgdesc="Headers and scripts for building modules for the $pkgdesc kernel"
	depends=('linux-kitsinger-5.16' 'pahole')

	cd $_srcname
	local builddir="$pkgdir/usr/lib/modules/$(<version)/build"

	msg2 "Installing build files..."
	install -Dt "$builddir" -m644 .config Makefile Module.symvers System.map \
		localversion.* version vmlinux
	install -Dt "$builddir/kernel" -m644 kernel/Makefile
	install -Dt "$builddir/arch/x86" -m644 arch/x86/Makefile
	cp -t "$builddir" -a scripts

	# required when STACK_VALIDATION is enabled
	install -Dt "$builddir/tools/objtool" tools/objtool/objtool

	# required when DEBUG_INFO_BTF_MODULES is enabled
	install -Dt "$builddir/tools/bpf/resolve_btfids" tools/bpf/resolve_btfids/resolve_btfids

	# add xfs and shmem for aufs building
	mkdir -p "$builddir"/{fs/xfs,mm}

	msg2 "Installing headers..."
	cp -t "$builddir" -a include
	cp -t "$builddir/arch/x86" -a arch/x86/include
	install -Dt "$builddir/arch/x86/kernel" -m644 arch/x86/kernel/asm-offsets.s

	install -Dt "$builddir/drivers/md" -m644 drivers/md/*.h
	install -Dt "$builddir/net/mac80211" -m644 net/mac80211/*.h

	# https://bugs.archlinux.org/task/13146
	install -Dt "$builddir/drivers/media/i2c" -m644 drivers/media/i2c/msp3400-driver.h

	# https://bugs.archlinux.org/task/20402
	install -Dt "$builddir/drivers/media/usb/dvb-usb" -m644 drivers/media/usb/dvb-usb/*.h
	install -Dt "$builddir/drivers/media/dvb-frontends" -m644 drivers/media/dvb-frontends/*.h
	install -Dt "$builddir/drivers/media/tuners" -m644 drivers/media/tuners/*.h

        # https://bugs.archlinux.org/task/71392
        install -Dt "$builddir/drivers/iio/common/hid-sensors" -m644 drivers/iio/common/hid-sensors/*.h

	msg2 "Installing KConfig files..."
	find . -name 'Kconfig*' -exec install -Dm644 {} "$builddir/{}" \;

	msg2 "Removing unneeded architectures..."
	local arch
	for arch in "$builddir"/arch/*/; do
		[[ $arch = */x86/ ]] && continue
		_msg3 "Removing $(basename "$arch")"
		rm -r "$arch"
	done

	msg2 "Removing documentation..."
	rm -r "$builddir/Documentation"

	msg2 "Removing broken symlinks..."
	find -L "$builddir" -type l -printf 'Removing %P\n' -delete

	msg2 "Removing loose objects..."
	find "$builddir" -type f -name '*.o' -printf 'Removing %P\n' -delete

	msg2 "Stripping build tools..."
	local file
	while read -rd '' file; do
		case "$(file -bi "$file")" in
			application/x-sharedlib\;*)      # Libraries (.so)
				strip -v $STRIP_SHARED "$file" ;;
			application/x-archive\;*)        # Libraries (.a)
				strip -v $STRIP_STATIC "$file" ;;
			application/x-executable\;*)     # Binaries
				strip -v $STRIP_BINARIES "$file" ;;
			application/x-pie-executable\;*) # Relocatable binaries
				strip -v $STRIP_SHARED "$file" ;;
		esac
	done < <(find "$builddir" -type f -perm -u+x ! -name vmlinux -print0)

	msg2 "Stripping vmlinux..."
	strip -v $STRIP_STATIC "$builddir/vmlinux"

	msg2 "Adding symlink..."
	mkdir -p "$pkgdir/usr/src"
	ln -sr "$builddir" "$pkgdir/usr/src/$pkgbase"
}

_package-docs() {
	pkgdesc="Documentation for the $pkgdesc kernel"
	depends=('linux-kitsinger-5.16')

	cd $_srcname
	local builddir="$pkgdir/usr/lib/modules/$(<version)/build"

	msg2 "Installing documentation..."
	local src dst
	while read -rd '' src; do
		dst="${src#Documentation/}"
		dst="$builddir/Documentation/${dst#output/}"
		install -Dm644 "$src" "$dst"
	done < <(find Documentation -name '.*' -prune -o ! -type d -print0)

	msg2 "Adding symlink..."
	mkdir -p "$pkgdir/usr/share/doc"
	ln -sr "$builddir/Documentation" "$pkgdir/usr/share/doc/$pkgbase"
}

pkgname=("$pkgbase" "$pkgbase-headers" "$pkgbase-docs")
for _p in "${pkgname[@]}"; do
	eval "package_$_p() {
		$(declare -f "_package${_p#$pkgbase}")
		_package${_p#$pkgbase}
	}"
done

validpgpkeys=(
	'ABAF11C65A2970B130ABE3C479BE3E4300411886'  # Linus Torvalds
	'647F28654894E3BD457199BE38DBBDC86092693E'  # Greg Kroah-Hartman
	'A2FF3A36AAA56654109064AB19802F8B0D70FC30'  # Jan Alexander Steffens (heftig)
	'C7E7849466FE2358343588377258734B41C31549'  # David Runge <dvzrv@archlinux.org>
)
